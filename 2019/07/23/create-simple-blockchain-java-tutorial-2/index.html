<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Part2 ：使用 Java 创建你的第一个区块链[译] | 风雪围城</title>

  
  <meta name="author" content="YueGS">
  

  
  <meta name="description" content="&amp;amp;emsp;本篇是该系列的第二篇，你可以在这里找到第一篇。原文链接在此。&amp;amp;emsp;在第本篇，我们将

创建一个简单的钱包
在我们的区块链上签发一个交易。

&amp;amp;emsp;上面的这些过程，其实就产生了我们自己的加密货币。&amp;amp;emsp;在上一篇文章中，我们有了一个可验证的、基本的区块链。但是，我们的链中仅仅存储了一些无用的信息。今天，我们将把这些无用的信息替换为交易数据。这允许我们可以创建一个简单的加密货币，我们称之为 “NoobCoin”。">
  

  
  
  <meta name="keywords" content="区块链,Java">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Part2 ：使用 Java 创建你的第一个区块链[译]"/>

  <meta property="og:site_name" content="风雪围城"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="风雪围城" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">风雪围城</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/about">About</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Part2 ：使用 Java 创建你的第一个区块链[译]</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/07/23/create-simple-blockchain-java-tutorial-2/" rel="bookmark">
        <time class="entry-date published" datetime="2019-07-23T01:22:01.000Z">
          2019-07-23
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>&amp;emsp;本篇是该系列的第二篇，你可以在这里找到<a target="_blank" rel="noopener" href="https://blog.yuegs.com/2018/05/26/create-simple-blockchain-java-tutorial-1/">第一篇</a>。原文链接<a target="_blank" rel="noopener" href="https://medium.com/programmers-blockchain/creating-your-first-blockchain-with-java-part-2-transactions-2cdac335e0ce">在此</a>。<br>&amp;emsp;在第本篇，我们将</p>
<ul>
<li>创建一个简单的钱包</li>
<li>在我们的区块链上签发一个交易。</li>
</ul>
<p>&amp;emsp;上面的这些过程，其实就产生了我们自己的加密货币。<br>&amp;emsp;在<a target="_blank" rel="noopener" href="https://blog.yuegs.com/2018/05/26/create-simple-blockchain-java-tutorial-1/">上一篇文章</a>中，我们有了一个可验证的、基本的区块链。但是，我们的链中仅仅存储了一些无用的信息。今天，我们将把这些无用的信息替换为交易数据。这允许我们可以创建一个简单的加密货币，我们称之为 “NoobCoin”。</p>
<span id="more"></span>
<p>&amp;emsp;本文中，还将使用 <a target="_blank" rel="noopener" href="https://www.bouncycastle.org/latest_releases.html?source=post_page---------------------------">Bouncy Castle</a> 和 <a target="_blank" rel="noopener" href="http://central.maven.org/maven2/com/google/code/gson/gson/2.8.2/gson-2.8.2.jar?source=post_page---------------------------">GSON</a> 库。</p>
<h3 id="1-准备钱包"><a href="#1-准备钱包" class="headerlink" title="1. 准备钱包"></a>1. 准备钱包</h3><p>&amp;emsp;在加密货币中，货币的所有权在区块链上以交易的形式<code>流转</code>，交易者拥有一个可以地址可以转入转出。因此，对于一个钱包而言，至少需要能够存储这些地址。更多的，钱包也可以作为一个软件用以在区块链上产生新的交易。<br><img src="https://raw.githubusercontent.com/yuegs/yuegs.github.io/master/images/blockChain/first-blockchain-2/transaction.png"></p>
<p>&amp;emsp;现在，让我们俩创建一个持有我们公钥和私钥的 <code>Wallet</code> 类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> noobchain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.PrivateKey;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Wallet</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> PrivateKey privateKey;</span><br><span class="line">	<span class="keyword">public</span> PublicKey publicKey ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;<strong>公钥和私钥有什么用？</strong><br>&amp;emsp;对于我们的加密货币 <code>noobcoin</code> 来说，公钥扮演者我们的钱包地址的角色，我们可以随意分享自己的公钥。私钥，是用来 <strong>签署(sign)</strong> 交易的，没有人能花费我们的 noobcoin，除非，他拥有我们的私钥。所以，用户的私钥一定要被保管好。公钥部分通常会和交易一起发送的，用以验证交易前面是否合法，交易内容是否被篡改。<br><img src="https://raw.githubusercontent.com/yuegs/yuegs.github.io/master/images/blockChain/first-blockchain-2/key.png"></p>
<p>&amp;emsp;公钥和私钥通过 <strong>KeyPair</strong> 生成，接下来，我们将使用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Elliptic-curve_cryptography">椭圆曲线加密算法</a> 来生成密钥对。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Wallet</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> PrivateKey privateKey;</span><br><span class="line">	<span class="keyword">public</span> PublicKey publicKey ;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Wallet</span><span class="params">()</span>&#123;</span><br><span class="line">		generateKeyPair();	</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateKeyPair</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="type">KeyPairGenerator</span> <span class="variable">keyGen</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;ECDSA&quot;</span>,<span class="string">&quot;BC&quot;</span>);</span><br><span class="line">			<span class="type">SecureRandom</span> <span class="variable">random</span> <span class="operator">=</span> SecureRandom.getInstance(<span class="string">&quot;SHA1PRNG&quot;</span>);</span><br><span class="line">			<span class="type">ECGenParameterSpec</span> <span class="variable">ecSpec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ECGenParameterSpec</span>(<span class="string">&quot;prime192v1&quot;</span>);</span><br><span class="line">			<span class="comment">// Initialize the key generator and generate a KeyPair</span></span><br><span class="line">			keyGen.initialize(ecSpec, random);   <span class="comment">//256 bytes provides an acceptable security level</span></span><br><span class="line">	        	<span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyGen.generateKeyPair();</span><br><span class="line">	        	<span class="comment">// Set the public and private keys from the keyPair</span></span><br><span class="line">	        	privateKey = keyPair.getPrivate();</span><br><span class="line">	        	publicKey = keyPair.getPublic();</span><br><span class="line">		&#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;现在，我们的钱包类差不多了，接下来，让我们来看看交易。<br><img src="https://raw.githubusercontent.com/yuegs/yuegs.github.io/master/images/blockChain/first-blockchain-2/cash.gif"></p>
<h3 id="2-交易和签名"><a href="#2-交易和签名" class="headerlink" title="2. 交易和签名"></a>2. 交易和签名</h3><p>&amp;emsp;每一个交易，都要携带一定的数据：</p>
<ul>
<li>发送者资金的公钥（译注：相当发送者的地址）</li>
<li>接受者资金的公钥（译注：相当于接受者的地址）</li>
<li>交易资金的数目</li>
<li>inputs，证明发送者有足够的币发送</li>
<li>outputs，接收地址收到的总金额</li>
<li>加密签名，保证发送者签署的交易不会被恶意篡改</li>
</ul>
<p>&amp;emsp;现在，我们来创建一个 <strong>Transaction</strong> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Transaction</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> String transactionId; <span class="comment">// this is also the hash of the transaction.</span></span><br><span class="line">	<span class="keyword">public</span> PublicKey sender; <span class="comment">// senders address/public key.</span></span><br><span class="line">	<span class="keyword">public</span> PublicKey reciepient; <span class="comment">// Recipients address/public key.</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">float</span> value;</span><br><span class="line">	<span class="keyword">public</span> <span class="type">byte</span>[] signature; <span class="comment">// this is to prevent anybody else from spending funds in our wallet.</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> ArrayList&lt;TransactionInput&gt; inputs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;TransactionInput&gt;();</span><br><span class="line">	<span class="keyword">public</span> ArrayList&lt;TransactionOutput&gt; outputs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;TransactionOutput&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sequence</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// a rough count of how many transactions have been generated. </span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Constructor: </span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Transaction</span><span class="params">(PublicKey from, PublicKey to, <span class="type">float</span> value,  ArrayList&lt;TransactionInput&gt; inputs)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.sender = from;</span><br><span class="line">		<span class="built_in">this</span>.reciepient = to;</span><br><span class="line">		<span class="built_in">this</span>.value = value;</span><br><span class="line">		<span class="built_in">this</span>.inputs = inputs;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// This Calculates the transaction hash (which will be used as its Id)</span></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">calulateHash</span><span class="params">()</span> &#123;</span><br><span class="line">		sequence++; <span class="comment">//increase the sequence to avoid 2 identical transactions having the same hash</span></span><br><span class="line">		<span class="keyword">return</span> StringUtil.applySha256(</span><br><span class="line">				StringUtil.getStringFromKey(sender) +</span><br><span class="line">				StringUtil.getStringFromKey(reciepient) +</span><br><span class="line">				Float.toString(value) + sequence</span><br><span class="line">				);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;此时，inputs 和 outputs 都是空的，后面我们会使用到它们。这个 Transaction 类还将包含生成、验证签名、验证交易等相关方法。但是，签名的目的是是什么？它们是如何工作的？</p>
<h4 id="签名的目的和工作原理"><a href="#签名的目的和工作原理" class="headerlink" title="签名的目的和工作原理"></a>签名的目的和工作原理</h4><p>&amp;emsp;<code>签名</code>在区块链中执行了两个非常重要的任务：首先，允许拥有者们消费他们的币，它会放置交易信息被篡改。<br><strong>&amp;emsp;私钥被用来签署数据，公钥被用来验证数据的完整性。</strong></p>
<blockquote>
<p>举个栗子：Bob 想向 Sally 转 2 个 NoobCoin，因此，钱包软件会生成这个交易，然后将这个交易提交给矿工，以将该数据包含连接到区块链中。如果矿工企图将这 2 个币的接收人改为 John。然而，幸运的是 Bob 使用私钥签署了这个交易数据，并且允许任何人使用他的公钥验证该交易的完整性、合法性。</p>
</blockquote>
<p>&amp;emsp;从上面的代码中，我们可以看到，所谓签名实际上一个 byte 数组，因此，下面让我们来生成它。首先，这里需要一个 <code>StringUtil</code> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Applies ECDSA Signature and returns the result ( as bytes ).</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] applyECDSASig(PrivateKey privateKey, String input) &#123;</span><br><span class="line">Signature dsa;</span><br><span class="line"><span class="type">byte</span>[] output = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    dsa = Signature.getInstance(<span class="string">&quot;ECDSA&quot;</span>, <span class="string">&quot;BC&quot;</span>);</span><br><span class="line">    dsa.initSign(privateKey);</span><br><span class="line">    <span class="type">byte</span>[] strByte = input.getBytes();</span><br><span class="line">    dsa.update(strByte);</span><br><span class="line">    <span class="type">byte</span>[] realSig = dsa.sign();</span><br><span class="line">    output = realSig;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Verifies a String signature </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">verifyECDSASig</span><span class="params">(PublicKey publicKey, String data, <span class="type">byte</span>[] signature)</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Signature</span> <span class="variable">ecdsaVerify</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;ECDSA&quot;</span>, <span class="string">&quot;BC&quot;</span>);</span><br><span class="line">    ecdsaVerify.initVerify(publicKey);</span><br><span class="line">    ecdsaVerify.update(data.getBytes());</span><br><span class="line">    <span class="keyword">return</span> ecdsaVerify.verify(signature);</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getStringFromKey</span><span class="params">(Key key)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> Base64.getEncoder().encodeToString(key.getEncoded());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;现在，在 <code>Transaction</code> 类的 <strong>generateSignature()</strong> 和 <strong>verifySignature()</strong> 方法中运用该签名方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//Signs all the data we dont wish to be tampered with.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateSignature</span><span class="params">(PrivateKey privateKey)</span> &#123;</span><br><span class="line">	<span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> StringUtil.getStringFromKey(sender) + StringUtil.getStringFromKey(reciepient) + Float.toString(value)	;</span><br><span class="line">	signature = StringUtil.applyECDSASig(privateKey,data);		</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Verifies the data we signed hasnt been tampered with</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verifiySignature</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> StringUtil.getStringFromKey(sender) + StringUtil.getStringFromKey(reciepient) + Float.toString(value)	;</span><br><span class="line">	<span class="keyword">return</span> StringUtil.verifyECDSASig(sender, data, signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;当该交易被矿工添加到区块链上的一个新块的时候，这个签名将会被验证。<br><img src="https://raw.githubusercontent.com/yuegs/yuegs.github.io/master/images/blockChain/first-blockchain-2/check.gif"></p>
<h3 id="3-测试钱包和签名"><a href="#3-测试钱包和签名" class="headerlink" title="3.测试钱包和签名"></a>3.测试钱包和签名</h3><p>&amp;emsp;现在，我们基本上已经完成了一半的工作。在 <code>NoobChain</code> 这个类中，添加一些新的变量，并替换到 main 方法中的一些方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.security.Security;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.GsonBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoobChain</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> ArrayList&lt;Block&gt; blockchain = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Block&gt;();</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">difficulty</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Wallet walletA;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Wallet walletB;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;	</span><br><span class="line">		<span class="comment">//Setup Bouncey castle as a Security Provider</span></span><br><span class="line">		Security.addProvider(<span class="keyword">new</span> <span class="title class_">org</span>.bouncycastle.jce.provider.BouncyCastleProvider()); </span><br><span class="line">		<span class="comment">//Create the new wallets</span></span><br><span class="line">		walletA = <span class="keyword">new</span> <span class="title class_">Wallet</span>();</span><br><span class="line">		walletB = <span class="keyword">new</span> <span class="title class_">Wallet</span>();</span><br><span class="line">		<span class="comment">//Test public and private keys</span></span><br><span class="line">		System.out.println(<span class="string">&quot;Private and public keys:&quot;</span>);</span><br><span class="line">		System.out.println(StringUtil.getStringFromKey(walletA.privateKey));</span><br><span class="line">		System.out.println(StringUtil.getStringFromKey(walletA.publicKey));</span><br><span class="line">		<span class="comment">//Create a test transaction from WalletA to walletB </span></span><br><span class="line">		<span class="type">Transaction</span> <span class="variable">transaction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transaction</span>(walletA.publicKey, walletB.publicKey, <span class="number">5</span>, <span class="literal">null</span>);</span><br><span class="line">		transaction.generateSignature(walletA.privateKey);</span><br><span class="line">		<span class="comment">//Verify the signature works and verify it from the public key</span></span><br><span class="line">		System.out.println(<span class="string">&quot;Is signature verified&quot;</span>);</span><br><span class="line">		System.out.println(transaction.verifiySignature());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;现在，我们创建了两个钱包，walletA 和 walletB，并且打印了 walletA 的私钥和公钥。你能看到的大概是这样子的<br><img src="https://raw.githubusercontent.com/yuegs/yuegs.github.io/master/images/blockChain/first-blockchain-2/result.png"></p>
<p>&amp;emsp;回过头来看，现在我们需要创建&#x2F;验证 outputs 和 inputs，并且将他们存储到区块链上的交易上。</p>
<h3 id="4-Inputs-和-Outputs"><a href="#4-Inputs-和-Outputs" class="headerlink" title="4. Inputs 和 Outputs"></a>4. Inputs 和 Outputs</h3><h4 id="1-加密货币的归属"><a href="#1-加密货币的归属" class="headerlink" title="1. 加密货币的归属"></a>1. 加密货币的归属</h4><p>&amp;emsp;如果你要拥有一个 bitcoin，首先你要收到一个 bitcoin。这个过程，并非是在总账单上将你的 bitcoin 加一 ，将发送者的 bitcoin 减一的过程。事实上，发送者肯定是前面也接收到的一个 bitcoin，然后才能将其发送到你的地址上。<br><strong>&amp;emsp;钱包的余额，是所有跟你地址（公钥）相关的未花费出去的交易输出的总和。</strong>(译注：后面将会看到，实际上这个链会维护一个由 publicKey 做 key，TransactionOutput 做 value 的 HashMap，这个 map 是所有交易输出的记录，通过 publicKey 可以查找到关于其拥有者的 bitcoin 数量)<br>&amp;emsp;接下来，我们遵从 bitcoin 惯例，将未花费出去的交易输出命名为：<em>UTXO</em>.<br>&amp;emsp;现在，我们来创建 <strong>TransactionInput</strong> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionInput</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> String transactionOutputId; <span class="comment">//Reference to TransactionOutputs -&gt; transactionId</span></span><br><span class="line">	<span class="keyword">public</span> TransactionOutput UTXO; <span class="comment">//Contains the Unspent transaction output</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">TransactionInput</span><span class="params">(String transactionOutputId)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.transactionOutputId = transactionOutputId;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;然后，创建 <strong>TransactionOutputs</strong> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionOutput</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> String id;</span><br><span class="line">	<span class="keyword">public</span> PublicKey reciepient; <span class="comment">//also known as the new owner of these coins.</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">float</span> value; <span class="comment">//the amount of coins they own</span></span><br><span class="line">	<span class="keyword">public</span> String parentTransactionId; <span class="comment">//the id of the transaction this output was created in</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//Constructor</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">TransactionOutput</span><span class="params">(PublicKey reciepient, <span class="type">float</span> value, String parentTransactionId)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.reciepient = reciepient;</span><br><span class="line">		<span class="built_in">this</span>.value = value;</span><br><span class="line">		<span class="built_in">this</span>.parentTransactionId = parentTransactionId;</span><br><span class="line">		<span class="built_in">this</span>.id = StringUtil.applySha256(StringUtil.getStringFromKey(reciepient)+Float.toString(value)+parentTransactionId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Check if coin belongs to you</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isMine</span><span class="params">(PublicKey publicKey)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (publicKey == reciepient);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;通过 Transaction outputs 可以获取到交易双方通过交易获取到的各自 bitcoin 的总数。因此，它也可以作为新交易的 inputs，以证明你有足够多的币用以交易。<br><img src="https://raw.githubusercontent.com/yuegs/yuegs.github.io/master/images/blockChain/first-blockchain-2/done.gif"></p>
<h4 id="2-处理交易"><a href="#2-处理交易" class="headerlink" title="2. 处理交易"></a>2. 处理交易</h4><p>&amp;emsp;链上的区块，可能包含了很多交易，区块链可能会很长很长很长很长，也因此，在处理新块的时候，可能会花费很长很长的时间，因为我们需要查找并检查它的输入。为了绕过这一点，我们将使用一个额外的集合，以保存未花费的交易。在 <code>NoobChain</code> 中，我们通过 <code>UTXO</code> 表示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoobChain</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> ArrayList&lt;Block&gt; blockchain = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Block&gt;();</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;String,TransactionOutput&gt; UTXOs = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,TransactionOutput&gt;(); <span class="comment">//list of all unspent transactions. </span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">difficulty</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Wallet walletA;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Wallet walletB;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;ok，现在是时候来揭晓事情的真相了。<br>&amp;emsp;让我们把所有事情集中起来，在 <code>Transactoin</code> 处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Returns true if new transaction could be created.	</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">processTransaction</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verifiySignature() == <span class="literal">false</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;#Transaction Signature failed to verify&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//gather transaction inputs (Make sure they are unspent):</span></span><br><span class="line">    <span class="keyword">for</span>(TransactionInput i : inputs) &#123;</span><br><span class="line">        i.UTXO = NoobChain.UTXOs.get(i.transactionOutputId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//check if transaction is valid:</span></span><br><span class="line">    <span class="keyword">if</span>(getInputsValue() &lt; NoobChain.minimumTransaction) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;#Transaction Inputs to small: &quot;</span> + getInputsValue());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//generate transaction outputs:</span></span><br><span class="line">    <span class="type">float</span> <span class="variable">leftOver</span> <span class="operator">=</span> getInputsValue() - value; <span class="comment">//get value of inputs then the left over change:</span></span><br><span class="line">    transactionId = calulateHash();</span><br><span class="line">    outputs.add(<span class="keyword">new</span> <span class="title class_">TransactionOutput</span>( <span class="built_in">this</span>.reciepient, value,transactionId)); <span class="comment">//send value to recipient</span></span><br><span class="line">    outputs.add(<span class="keyword">new</span> <span class="title class_">TransactionOutput</span>( <span class="built_in">this</span>.sender, leftOver,transactionId)); <span class="comment">//send the left over &#x27;change&#x27; back to sender		</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//add outputs to Unspent list</span></span><br><span class="line">    <span class="keyword">for</span>(TransactionOutput o : outputs) &#123;</span><br><span class="line">        NoobChain.UTXOs.put(o.id , o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//remove transaction inputs from UTXO lists as spent:</span></span><br><span class="line">    <span class="keyword">for</span>(TransactionInput i : inputs) &#123;</span><br><span class="line">        <span class="keyword">if</span>(i.UTXO == <span class="literal">null</span>) <span class="keyword">continue</span>; <span class="comment">//if Transaction can&#x27;t be found skip it </span></span><br><span class="line">        NoobChain.UTXOs.remove(i.UTXO.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//returns sum of inputs(UTXOs) values</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getInputsValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">float</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(TransactionInput i : inputs) &#123;</span><br><span class="line">        <span class="keyword">if</span>(i.UTXO == <span class="literal">null</span>) <span class="keyword">continue</span>; <span class="comment">//if Transaction can&#x27;t be found skip it </span></span><br><span class="line">        total += i.UTXO.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//returns sum of outputs:</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getOutputsValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">float</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(TransactionOutput o : outputs) &#123;</span><br><span class="line">        total += o.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;使用这个方法，我们执行一些检查，确保交易的合法性，接着，收集输入，并产生输出。<br>&amp;emsp;很重要的一点，在结尾处，我们从 <em>UTXO</em> 中删除了 Inputs。这意味着 <strong>transaction output</strong> 仅有一次机会作为输入…所有输入值，都将在本次交易中被使用，如果没有使用完，剩余的部分会返回到自身中。<br><img src="https://raw.githubusercontent.com/yuegs/yuegs.github.io/master/images/blockChain/first-blockchain-2/transaction-2.png"><br>&amp;emsp;最后，让我们来更新下钱包：</p>
<ul>
<li>计算余额（通过对 UTXO 循环，计算属于“我”的余额，判断是否有足够的余额进行交易 ）。</li>
<li>产生新的 transaction(交易)。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.ECGenParameterSpec;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Wallet</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> PrivateKey privateKey;</span><br><span class="line">	<span class="keyword">public</span> PublicKey publicKey;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> HashMap&lt;String,TransactionOutput&gt; UTXOs = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,TransactionOutput&gt;(); <span class="comment">//only UTXOs owned by this wallet.</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Wallet</span><span class="params">()</span> &#123;...</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateKeyPair</span><span class="params">()</span> &#123;...</span><br><span class="line">	</span><br><span class="line">  <span class="comment">//returns balance and stores the UTXO&#x27;s owned by this wallet in this.UTXOs</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getBalance</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">float</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;	</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, TransactionOutput&gt; item: NoobChain.UTXOs.entrySet())&#123;</span><br><span class="line">        	<span class="type">TransactionOutput</span> <span class="variable">UTXO</span> <span class="operator">=</span> item.getValue();</span><br><span class="line">            <span class="keyword">if</span>(UTXO.isMine(publicKey)) &#123; <span class="comment">//if output belongs to me ( if coins belong to me )</span></span><br><span class="line">            	UTXOs.put(UTXO.id,UTXO); <span class="comment">//add it to our list of unspent transactions.</span></span><br><span class="line">            	total += UTXO.value ; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  </span><br><span class="line">		<span class="keyword">return</span> total;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//Generates and returns a new transaction from this wallet.</span></span><br><span class="line">	<span class="keyword">public</span> Transaction <span class="title function_">sendFunds</span><span class="params">(PublicKey _recipient,<span class="type">float</span> value )</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(getBalance() &lt; value) &#123; <span class="comment">//gather balance and check funds.</span></span><br><span class="line">			System.out.println(<span class="string">&quot;#Not Enough funds to send transaction. Transaction Discarded.&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">//create array list of inputs</span></span><br><span class="line">		ArrayList&lt;TransactionInput&gt; inputs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;TransactionInput&gt;();</span><br><span class="line">    </span><br><span class="line">		<span class="type">float</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, TransactionOutput&gt; item: UTXOs.entrySet())&#123;</span><br><span class="line">			<span class="type">TransactionOutput</span> <span class="variable">UTXO</span> <span class="operator">=</span> item.getValue();</span><br><span class="line">			total += UTXO.value;</span><br><span class="line">			inputs.add(<span class="keyword">new</span> <span class="title class_">TransactionInput</span>(UTXO.id));</span><br><span class="line">			<span class="keyword">if</span>(total &gt; value) <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">Transaction</span> <span class="variable">newTransaction</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transaction</span>(publicKey, _recipient , value, inputs);</span><br><span class="line">		newTransaction.generateSignature(privateKey);</span><br><span class="line">		<span class="keyword">for</span>(TransactionInput input: inputs)&#123;</span><br><span class="line">			UTXOs.remove(input.transactionOutputId);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> newTransaction;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-将交易添加到区块中"><a href="#6-将交易添加到区块中" class="headerlink" title="6. 将交易添加到区块中"></a>6. 将交易添加到区块中</h3><p>&amp;emsp;现在，我们有了一个可以工作的交易系统了，接下来，需要将其实现到区块链上。现在，我们可以将以前那些无用的数据替换为 ArrayList of transactions(交易列表)，同时，使用根哈希的方式，计算区块的哈希值。<br>&amp;emsp;下面，在 StringUtil 中增加一个获取根哈希（译注：可以参考 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/File:Hash_Tree.svg">维基百科</a>）的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Tacks in array of transactions and returns a merkle root.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getMerkleRoot</span><span class="params">(ArrayList&lt;Transaction&gt; transactions)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> transactions.size();</span><br><span class="line">    ArrayList&lt;String&gt; previousTreeLayer = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">    <span class="keyword">for</span>(Transaction transaction : transactions) &#123;</span><br><span class="line">        previousTreeLayer.add(transaction.transactionId);</span><br><span class="line">    &#125;</span><br><span class="line">    ArrayList&lt;String&gt; treeLayer = previousTreeLayer;</span><br><span class="line">    <span class="keyword">while</span>(count &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        treeLayer = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>; i &lt; previousTreeLayer.size(); i++) &#123;</span><br><span class="line">            treeLayer.add(applySha256(previousTreeLayer.get(i-<span class="number">1</span>) + previousTreeLayer.get(i)));</span><br><span class="line">        &#125;</span><br><span class="line">        count = treeLayer.size();</span><br><span class="line">        previousTreeLayer = treeLayer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">merkleRoot</span> <span class="operator">=</span> (treeLayer.size() == <span class="number">1</span>) ? treeLayer.get(<span class="number">0</span>) : <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> merkleRoot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;再接下来，进行 <strong>Block</strong> 中的修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Block</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> String hash;</span><br><span class="line">	<span class="keyword">public</span> String previousHash; </span><br><span class="line">	<span class="keyword">public</span> String merkleRoot;</span><br><span class="line">	<span class="keyword">public</span> ArrayList&lt;Transaction&gt; transactions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Transaction&gt;(); <span class="comment">//our data will be a simple message.</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">long</span> timeStamp; <span class="comment">//as number of milliseconds since 1/1/1970.</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> nonce;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//Block Constructor.  </span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Block</span><span class="params">(String previousHash )</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.previousHash = previousHash;</span><br><span class="line">		<span class="built_in">this</span>.timeStamp = <span class="keyword">new</span> <span class="title class_">Date</span>().getTime();</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">this</span>.hash = calculateHash(); <span class="comment">//Making sure we do this after we set the other values.</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//Calculate new hash based on blocks contents</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">calculateHash</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">calculatedhash</span> <span class="operator">=</span> StringUtil.applySha256( </span><br><span class="line">				previousHash +</span><br><span class="line">				Long.toString(timeStamp) +</span><br><span class="line">				Integer.toString(nonce) + </span><br><span class="line">				merkleRoot</span><br><span class="line">				);</span><br><span class="line">		<span class="keyword">return</span> calculatedhash;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//Increases nonce value until hash target is reached.</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mineBlock</span><span class="params">(<span class="type">int</span> difficulty)</span> &#123;</span><br><span class="line">		merkleRoot = StringUtil.getMerkleRoot(transactions);</span><br><span class="line">		<span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> StringUtil.getDificultyString(difficulty); <span class="comment">//Create a string with difficulty * &quot;0&quot; </span></span><br><span class="line">		<span class="keyword">while</span>(!hash.substring( <span class="number">0</span>, difficulty).equals(target)) &#123;</span><br><span class="line">			nonce ++;</span><br><span class="line">			hash = calculateHash();</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">&quot;Block Mined!!! : &quot;</span> + hash);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//Add transactions to this block</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addTransaction</span><span class="params">(Transaction transaction)</span> &#123;</span><br><span class="line">		<span class="comment">//process transaction and check if valid, unless block is genesis block then ignore.</span></span><br><span class="line">		<span class="keyword">if</span>(transaction == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;		</span><br><span class="line">		<span class="keyword">if</span>((previousHash != <span class="string">&quot;0&quot;</span>)) &#123;</span><br><span class="line">			<span class="keyword">if</span>((transaction.processTransaction() != <span class="literal">true</span>)) &#123;</span><br><span class="line">				System.out.println(<span class="string">&quot;Transaction failed to process. Discarded.&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		transactions.add(transaction);</span><br><span class="line">		System.out.println(<span class="string">&quot;Transaction Successfully added to Block&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;注意，我们更新了 Block 的构造器，不在传入一个字符串，并且添加了用于计算哈希值的 merkle root(根哈希)属性。<br>&amp;emsp;<em>addTransaction</em> 方法将返回一个 boolean，以表示交易是否成功。</p>
<h3 id="7-华丽的落幕"><a href="#7-华丽的落幕" class="headerlink" title="7. 华丽的落幕"></a>7. 华丽的落幕</h3><p>&amp;emsp;最后，我们还需要测试从钱包中消费 noobcoin ，更新区块链合法性检测。但是，首先，我们还是需要引入这些新的 coins。其实，还是有很多方式引入新的 coins，比如在比特币区块链上，新币可以作为对矿工挖到矿的奖励。在本文中，我们将采用直接在创世区块中释放所有币的方式。<br>&amp;emsp;我们来更新下 <code>NoobChain</code> 类：</p>
<ul>
<li>创世区块将向 walletA 发放 100 个 Noobcoins.</li>
<li>当交易发生后，检测区块链的合法性</li>
<li>通过一些交易，测试是否一切工作 ok</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoobChain</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> ArrayList&lt;Block&gt; blockchain = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Block&gt;();</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;String,TransactionOutput&gt; UTXOs = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,TransactionOutput&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">difficulty</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">float</span> <span class="variable">minimumTransaction</span> <span class="operator">=</span> <span class="number">0.1f</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Wallet walletA;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Wallet walletB;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Transaction genesisTransaction;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;	</span><br><span class="line">		<span class="comment">//add our blocks to the blockchain ArrayList:</span></span><br><span class="line">		Security.addProvider(<span class="keyword">new</span> <span class="title class_">org</span>.bouncycastle.jce.provider.BouncyCastleProvider()); <span class="comment">//Setup Bouncey castle as a Security Provider</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//Create wallets:</span></span><br><span class="line">		walletA = <span class="keyword">new</span> <span class="title class_">Wallet</span>();</span><br><span class="line">		walletB = <span class="keyword">new</span> <span class="title class_">Wallet</span>();		</span><br><span class="line">		<span class="type">Wallet</span> <span class="variable">coinbase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Wallet</span>();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//create genesis transaction, which sends 100 NoobCoin to walletA: </span></span><br><span class="line">		genesisTransaction = <span class="keyword">new</span> <span class="title class_">Transaction</span>(coinbase.publicKey, walletA.publicKey, <span class="number">100f</span>, <span class="literal">null</span>);</span><br><span class="line">		genesisTransaction.generateSignature(coinbase.privateKey);	 <span class="comment">//manually sign the genesis transaction	</span></span><br><span class="line">		genesisTransaction.transactionId = <span class="string">&quot;0&quot;</span>; <span class="comment">//manually set the transaction id</span></span><br><span class="line">		genesisTransaction.outputs.add(<span class="keyword">new</span> <span class="title class_">TransactionOutput</span>(genesisTransaction.reciepient, genesisTransaction.value, genesisTransaction.transactionId)); <span class="comment">//manually add the Transactions Output</span></span><br><span class="line">		UTXOs.put(genesisTransaction.outputs.get(<span class="number">0</span>).id, genesisTransaction.outputs.get(<span class="number">0</span>)); <span class="comment">//its important to store our first transaction in the UTXOs list.</span></span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">&quot;Creating and Mining Genesis block... &quot;</span>);</span><br><span class="line">		<span class="type">Block</span> <span class="variable">genesis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Block</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">		genesis.addTransaction(genesisTransaction);</span><br><span class="line">		addBlock(genesis);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//testing</span></span><br><span class="line">		<span class="type">Block</span> <span class="variable">block1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Block</span>(genesis.hash);</span><br><span class="line">		System.out.println(<span class="string">&quot;\nWalletA&#x27;s balance is: &quot;</span> + walletA.getBalance());</span><br><span class="line">		System.out.println(<span class="string">&quot;\nWalletA is Attempting to send funds (40) to WalletB...&quot;</span>);</span><br><span class="line">		block1.addTransaction(walletA.sendFunds(walletB.publicKey, <span class="number">40f</span>));</span><br><span class="line">		addBlock(block1);</span><br><span class="line">		System.out.println(<span class="string">&quot;\nWalletA&#x27;s balance is: &quot;</span> + walletA.getBalance());</span><br><span class="line">		System.out.println(<span class="string">&quot;WalletB&#x27;s balance is: &quot;</span> + walletB.getBalance());</span><br><span class="line">		</span><br><span class="line">		<span class="type">Block</span> <span class="variable">block2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Block</span>(block1.hash);</span><br><span class="line">		System.out.println(<span class="string">&quot;\nWalletA Attempting to send more funds (1000) than it has...&quot;</span>);</span><br><span class="line">		block2.addTransaction(walletA.sendFunds(walletB.publicKey, <span class="number">1000f</span>));</span><br><span class="line">		addBlock(block2);</span><br><span class="line">		System.out.println(<span class="string">&quot;\nWalletA&#x27;s balance is: &quot;</span> + walletA.getBalance());</span><br><span class="line">		System.out.println(<span class="string">&quot;WalletB&#x27;s balance is: &quot;</span> + walletB.getBalance());</span><br><span class="line">		</span><br><span class="line">		<span class="type">Block</span> <span class="variable">block3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Block</span>(block2.hash);</span><br><span class="line">		System.out.println(<span class="string">&quot;\nWalletB is Attempting to send funds (20) to WalletA...&quot;</span>);</span><br><span class="line">		block3.addTransaction(walletB.sendFunds( walletA.publicKey, <span class="number">20</span>));</span><br><span class="line">		System.out.println(<span class="string">&quot;\nWalletA&#x27;s balance is: &quot;</span> + walletA.getBalance());</span><br><span class="line">		System.out.println(<span class="string">&quot;WalletB&#x27;s balance is: &quot;</span> + walletB.getBalance());</span><br><span class="line">		</span><br><span class="line">		isChainValid();</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title function_">isChainValid</span><span class="params">()</span> &#123;</span><br><span class="line">		Block currentBlock; </span><br><span class="line">		Block previousBlock;</span><br><span class="line">		<span class="type">String</span> <span class="variable">hashTarget</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[difficulty]).replace(<span class="string">&#x27;\0&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">		HashMap&lt;String,TransactionOutput&gt; tempUTXOs = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,TransactionOutput&gt;(); <span class="comment">//a temporary working list of unspent transactions at a given block state.</span></span><br><span class="line">		tempUTXOs.put(genesisTransaction.outputs.get(<span class="number">0</span>).id, genesisTransaction.outputs.get(<span class="number">0</span>));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//loop through blockchain to check hashes:</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>; i &lt; blockchain.size(); i++) &#123;</span><br><span class="line">			</span><br><span class="line">			currentBlock = blockchain.get(i);</span><br><span class="line">			previousBlock = blockchain.get(i-<span class="number">1</span>);</span><br><span class="line">			<span class="comment">//compare registered hash and calculated hash:</span></span><br><span class="line">			<span class="keyword">if</span>(!currentBlock.hash.equals(currentBlock.calculateHash()) )&#123;</span><br><span class="line">				System.out.println(<span class="string">&quot;#Current Hashes not equal&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//compare previous hash and registered previous hash</span></span><br><span class="line">			<span class="keyword">if</span>(!previousBlock.hash.equals(currentBlock.previousHash) ) &#123;</span><br><span class="line">				System.out.println(<span class="string">&quot;#Previous Hashes not equal&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//check if hash is solved</span></span><br><span class="line">			<span class="keyword">if</span>(!currentBlock.hash.substring( <span class="number">0</span>, difficulty).equals(hashTarget)) &#123;</span><br><span class="line">				System.out.println(<span class="string">&quot;#This block hasn&#x27;t been mined&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//loop thru blockchains transactions:</span></span><br><span class="line">			TransactionOutput tempOutput;</span><br><span class="line">			<span class="keyword">for</span>(<span class="type">int</span> t=<span class="number">0</span>; t &lt;currentBlock.transactions.size(); t++) &#123;</span><br><span class="line">				<span class="type">Transaction</span> <span class="variable">currentTransaction</span> <span class="operator">=</span> currentBlock.transactions.get(t);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span>(!currentTransaction.verifiySignature()) &#123;</span><br><span class="line">					System.out.println(<span class="string">&quot;#Signature on Transaction(&quot;</span> + t + <span class="string">&quot;) is Invalid&quot;</span>);</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(currentTransaction.getInputsValue() != currentTransaction.getOutputsValue()) &#123;</span><br><span class="line">					System.out.println(<span class="string">&quot;#Inputs are note equal to outputs on Transaction(&quot;</span> + t + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">for</span>(TransactionInput input: currentTransaction.inputs) &#123;	</span><br><span class="line">					tempOutput = tempUTXOs.get(input.transactionOutputId);</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span>(tempOutput == <span class="literal">null</span>) &#123;</span><br><span class="line">						System.out.println(<span class="string">&quot;#Referenced input on Transaction(&quot;</span> + t + <span class="string">&quot;) is Missing&quot;</span>);</span><br><span class="line">						<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span>(input.UTXO.value != tempOutput.value) &#123;</span><br><span class="line">						System.out.println(<span class="string">&quot;#Referenced input Transaction(&quot;</span> + t + <span class="string">&quot;) value is Invalid&quot;</span>);</span><br><span class="line">						<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					tempUTXOs.remove(input.transactionOutputId);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">for</span>(TransactionOutput output: currentTransaction.outputs) &#123;</span><br><span class="line">					tempUTXOs.put(output.id, output);</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span>( currentTransaction.outputs.get(<span class="number">0</span>).reciepient != currentTransaction.reciepient) &#123;</span><br><span class="line">					System.out.println(<span class="string">&quot;#Transaction(&quot;</span> + t + <span class="string">&quot;) output reciepient is not who it should be&quot;</span>);</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>( currentTransaction.outputs.get(<span class="number">1</span>).reciepient != currentTransaction.sender) &#123;</span><br><span class="line">					System.out.println(<span class="string">&quot;#Transaction(&quot;</span> + t + <span class="string">&quot;) output &#x27;change&#x27; is not sender.&quot;</span>);</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println(<span class="string">&quot;Blockchain is valid&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addBlock</span><span class="params">(Block newBlock)</span> &#123;</span><br><span class="line">		newBlock.mineBlock(difficulty);</span><br><span class="line">		blockchain.add(newBlock);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&amp;emsp;你可以在 <a target="_blank" rel="noopener" href="https://github.com/CryptoKass/NoobChain-Tutorial-Part-2/tree/master/src/noobchain">Github</a> 上下载到这个项目。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%93%88%E5%B8%8C%E6%A0%91">哈希树</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/区块链/">区块链</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/区块链/">区块链</a><a href="/tags/Java/">Java</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    
    &copy; 2024 YueGS
    
  </p>
</footer>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-116967169-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-116967169-1');
</script>

    
  </div>
</div>
</body>
</html>