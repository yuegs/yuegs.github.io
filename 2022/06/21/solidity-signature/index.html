<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>EIP712 &amp; EIP1271 | é£é›ªå›´åŸ</title>

  
  <meta name="author" content="YueGS">
  

  
  <meta name="description" content="ç­¾åï¼Œè¯æ˜äº‹ä»¶æ˜¯åœ¨é’±åŒ…çš„å®é™…æŒæœ‰è€…æˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œçš„ï¼›éªŒè¯ï¼Œæ˜¯é€šè¿‡åŠ å¯†ç®—æ³•å¯¹ç­¾åæœ‰æ•ˆæ€§çš„æ£€æµ‹ã€‚ç­¾åå¹¶éªŒè¯é€šè¿‡ï¼Œæ˜¯äº¤æ˜“å’Œæˆæƒçš„åŸºç¡€ã€‚æœ¬æ–‡ï¼Œä¸»è¦å›´ç»•ç€ç»“æ„åŒ–æ•°æ®çš„ç­¾å&amp;#x2F;éªŒè¯ä»¥åŠåˆçº¦ç­¾å&amp;#x2F;éªŒè¯å±•å¼€ã€‚å…¶å¯¹åº”ç€ EIP712 ä»¥åŠ EIP1271 åè®®ã€‚">
  

  
  
  <meta name="keywords" content="EIP712,EIP1271">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="EIP712 &amp; EIP1271"/>

  <meta property="og:site_name" content="é£é›ªå›´åŸ"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="é£é›ªå›´åŸ" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">é£é›ªå›´åŸ</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/categories">Categories</a></li>
      
        <li><a href="/tags">Tags</a></li>
      
        <li><a href="/about">About</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>EIP712 &amp; EIP1271</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2022/06/21/solidity-signature/" rel="bookmark">
        <time class="entry-date published" datetime="2022-06-20T17:07:28.000Z">
          2022-06-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p><img src="https://raw.githubusercontent.com/yuegs/yuegs.github.io/master/images/smart-contract/smart-contract-signature/signature.png"></p>
<p>ç­¾åï¼Œè¯æ˜äº‹ä»¶æ˜¯åœ¨é’±åŒ…çš„å®é™…æŒæœ‰è€…æˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œçš„ï¼›éªŒè¯ï¼Œæ˜¯é€šè¿‡åŠ å¯†ç®—æ³•å¯¹ç­¾åæœ‰æ•ˆæ€§çš„æ£€æµ‹ã€‚ç­¾åå¹¶éªŒè¯é€šè¿‡ï¼Œæ˜¯äº¤æ˜“å’Œæˆæƒçš„åŸºç¡€ã€‚<br>æœ¬æ–‡ï¼Œä¸»è¦å›´ç»•ç€ç»“æ„åŒ–æ•°æ®çš„ç­¾å&#x2F;éªŒè¯ä»¥åŠåˆçº¦ç­¾å&#x2F;éªŒè¯å±•å¼€ã€‚å…¶å¯¹åº”ç€ EIP712 ä»¥åŠ EIP1271 åè®®ã€‚</p>
<span id="more"></span>

<h3 id="1-æ•°æ®ç­¾åå’ŒéªŒè¯"><a href="#1-æ•°æ®ç­¾åå’ŒéªŒè¯" class="headerlink" title="1. æ•°æ®ç­¾åå’ŒéªŒè¯"></a>1. æ•°æ®ç­¾åå’ŒéªŒè¯</h3><blockquote>
<p>The set of signable messages is extended from transactions and bytestrings ğ•‹ âˆª ğ”¹â¸â¿ to also include structured data ğ•Š. The new set of signable messages is thus ğ•‹ âˆª ğ”¹â¸â¿ âˆª ğ•Š. They are encoded to bytestrings suitable for hashing and signing as follows:<br><strong><strong>encode(transaction : ğ•‹)</strong></strong> &#x3D; RLP_encode(transaction)<br><strong><strong>encode(message : ğ”¹â¸â¿)</strong></strong> &#x3D; â€œ\x19Ethereum Signed Message:\nâ€ â€– len(message) â€– message where len(message) is the non-zero-padded ascii-decimal encoding of the number of bytes in message.<br><strong><strong>encode(domainSeparator : ğ”¹Â²âµâ¶, message : ğ•Š)</strong></strong> &#x3D; â€œ\x19\x01â€ â€– domainSeparator â€– hashStruct(message) where domainSeparator and hashStruct(message) are defined belowï¼š<br><strong><strong>hashStruct(s : ğ•Š)</strong></strong> &#x3D; keccak256(typeHash â€– encodeData(s)) where typeHash &#x3D; keccak256(encodeType(typeOf(s)))<br><strong><strong>domainSeparator</strong></strong> &#x3D; hashStruct(eip712Domain)<br><a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-712">å¼•ç”¨æ¥æº</a></p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒåŸºäºéç»“æ„åŒ–æ•°æ® byte çš„ç­¾åå’ŒåŸºäºç»“æ„åŒ–æ•°æ®çš„ç­¾åï¼Œéƒ½åŒ…å«ä¸€äº›ç‰¹æ®Šå‰ç¼€ï¼Œè¿™ç§è®¾è®¡ä¸»è¦æ˜¯ä¸ºäº†<strong><strong>é™ä½ä¸åŒç­¾åæ–¹å¼çš„ç¢°æ’é£é™©ï¼Œé¿å…é‡æ”¾æ”»å‡»ã€‚</strong></strong></p>
<p>å¯¹äºäº¤æ˜“çš„ç­¾åå’Œéç»“æ„åŒ–æ•°æ®çš„ç­¾åï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œä¸‹è¿°é‡ç‚¹å…³æ³¨ç»“æ„åŒ–æ•°æ®ç­¾åã€‚</p>
<h3 id="2-EIP712"><a href="#2-EIP712" class="headerlink" title="2. EIP712"></a>2. EIP712</h3><p>å¯¹ç»“æ„åŒ–æ•°æ®çš„ç­¾åï¼Œå°†éµå¾ª EIP712 åè®®ã€‚è¯¥åè®®å°†ä½¿å¾—ç­¾åè¿‡ç¨‹ä¸­æ•°æ®å…·æœ‰æ›´å¥½çš„å¯è¯»æ€§å’Œé€æ˜æ€§ã€‚<br>ä»¥ä¸‹ï¼Œæ˜¯åœ¨ Wyvern åè®®ä¸­ï¼Œæ„å»ºå–å•çš„è¿‡ç¨‹ã€‚å°†è°ƒç”¨ MetaMask è¿›è¡Œç­¾åã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> domain = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Wyvern Exchange Contract&#x27;</span>,</span><br><span class="line">  <span class="attr">version</span>: <span class="string">&#x27;2.3&#x27;</span>,</span><br><span class="line">  <span class="attr">chainId</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="attr">verifyingContract</span>: <span class="variable constant_">MARKETPLACE_ADDR</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The named list of all type definitions</span></span><br><span class="line"><span class="keyword">const</span> types = &#123;</span><br><span class="line">  <span class="title class_">Order</span>: [</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;exchange&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;address&#x27;</span> </span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;maker&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;address&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;taker&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;address&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;makerRelayerFee&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint256&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;takerRelayerFee&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint256&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;makerProtocolFee&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint256&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;takerProtocolFee&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint256&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;feeRecipient&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;address&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;feeMethod&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint8&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;side&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint8&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;saleKind&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint8&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;target&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;address&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;howToCall&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint8&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;calldata&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;bytes&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;replacementPattern&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;bytes&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;staticTarget&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;address&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;staticExtradata&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;bytes&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;paymentToken&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;address&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;basePrice&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint256&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;extra&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint256&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;listingTime&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint256&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;expirationTime&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint256&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;salt&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint256&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;nonce&#x27;</span>, <span class="attr">type</span>: <span class="string">&#x27;uint256&#x27;</span> &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The data to sign</span></span><br><span class="line"><span class="keyword">const</span> value = &#123;</span><br><span class="line">      <span class="attr">exchange</span>: <span class="variable constant_">MARKETPLACE_ADDR</span>,</span><br><span class="line">      <span class="attr">maker</span>: maker,</span><br><span class="line">      <span class="attr">taker</span>: taker,</span><br><span class="line">      <span class="attr">makerRelayerFee</span>: <span class="variable constant_">MAKER_RELAYER_FEE</span>,</span><br><span class="line">      <span class="attr">takerRelayerFee</span>: <span class="variable constant_">TAKER_RELAYER_FEE</span>,</span><br><span class="line">      <span class="attr">makerProtocolFee</span>: <span class="variable constant_">MAKER_PROTOCOL_FEE</span>,</span><br><span class="line">      <span class="attr">takerProtocolFee</span>: <span class="variable constant_">TAKER_PROTOCOL_FEE</span>,</span><br><span class="line">      <span class="attr">feeRecipient</span>: <span class="variable constant_">FEE_RECIPIENT</span>,</span><br><span class="line">      <span class="attr">feeMethod</span>: feeMethod,</span><br><span class="line">      <span class="attr">side</span>: side,</span><br><span class="line">      <span class="attr">saleKind</span>: saleKind,</span><br><span class="line">      <span class="attr">target</span>: <span class="variable constant_">ORDER_TARGET</span>,</span><br><span class="line">      <span class="attr">howToCall</span>: howToCall,</span><br><span class="line">      <span class="attr">calldata</span>: calldata,</span><br><span class="line">      <span class="attr">replacementPattern</span>: <span class="variable constant_">SELL_REPLACEMENT_PATTERN</span>,</span><br><span class="line">      <span class="attr">staticTarget</span>: <span class="variable constant_">ZEOR_ADDRESS</span>,</span><br><span class="line">      <span class="attr">staticExtradata</span>: <span class="variable constant_">EMPTY_DATA</span>,</span><br><span class="line">      <span class="attr">paymentToken</span>: paymentToken,</span><br><span class="line">      <span class="attr">basePrice</span>: basePrice,</span><br><span class="line">      <span class="attr">extra</span>: extra,</span><br><span class="line">      <span class="attr">listingTime</span>: <span class="title class_">Web3</span>.<span class="property">utils</span>.<span class="title function_">toBN</span>(listingTime).<span class="title function_">toString</span>(),</span><br><span class="line">      <span class="attr">expirationTime</span>: <span class="title class_">Web3</span>.<span class="property">utils</span>.<span class="title function_">toBN</span>(expirationTime).<span class="title function_">toString</span>(),</span><br><span class="line">      <span class="attr">salt</span>: <span class="title function_">generatePseudoRandomSalt</span>(),</span><br><span class="line">      <span class="attr">nonce</span>: <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">signature = <span class="keyword">await</span> signer.<span class="title function_">_signTypedData</span>(domain, types, value);</span><br></pre></td></tr></table></figure>

<p>åˆçº¦ä¸­çš„éªŒè¯è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> Derive the domain separator for EIP-712 signatures.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The domain separator.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_deriveDomainSeparator</span>(<span class="params"></span>) private view returns (bytes32) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">keccak256</span>(</span><br><span class="line">        abi.<span class="title function_">encode</span>(</span><br><span class="line">            _EIP_712_DOMAIN_TYPEHASH, <span class="comment">// keccak256(&quot;EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)&quot;)</span></span><br><span class="line">            _NAME_HASH, <span class="comment">// keccak256(&quot;Wyvern Exchange Contract&quot;)</span></span><br><span class="line">            _VERSION_HASH, <span class="comment">// keccak256(bytes(&quot;2.3&quot;))</span></span><br><span class="line">            _CHAIN_ID, <span class="comment">// <span class="doctag">NOTE:</span> this is fixed, need to use solidity 0.5+ or make external call to support!</span></span><br><span class="line">            <span class="title function_">address</span>(<span class="variable language_">this</span>)</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> Hash an order, returning the hash that a client must sign via EIP-712 including the message prefix</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> order Order to hash</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> nonce Nonce to hash</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Hash of message prefix and order hash per Ethereum format</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hashToSign</span>(<span class="params">Order memory order, uint nonce</span>)</span><br><span class="line">internal</span><br><span class="line">view</span><br><span class="line">returns (bytes32)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">keccak256</span>(</span><br><span class="line">        abi.<span class="title function_">encodePacked</span>(<span class="string">&quot;\x19\x01&quot;</span>, <span class="variable constant_">DOMAIN_SEPARATOR</span>, <span class="title function_">hashOrder</span>(order, nonce))</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> Assert an order is valid and return its hash</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> order Order to validate</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> nonce Nonce to validate</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sig ECDSA signature</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requireValidOrder</span>(<span class="params">Order memory order, Sig memory sig, uint nonce</span>)</span><br><span class="line">internal</span><br><span class="line">view</span><br><span class="line">returns (bytes32)</span><br><span class="line">&#123;</span><br><span class="line">    bytes32 hash = <span class="title function_">hashToSign</span>(order, nonce);</span><br><span class="line">    <span class="built_in">require</span>(<span class="title function_">validateOrder</span>(hash, order, sig));</span><br><span class="line">    <span class="keyword">return</span> hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> Validate a provided previously approved / signed order, hash, and signature.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> hash Order hash (already calculated, passed to avoid recalculation)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> order Order to validate</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sig ECDSA signature</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">validateOrder</span>(<span class="params">bytes32 hash, Order memory order, Sig memory sig</span>)</span><br><span class="line">internal</span><br><span class="line">view</span><br><span class="line">returns (bool)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* recover via ECDSA, signed by maker (already verified as non-zero). */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">ecrecover</span>(hash, sig.<span class="property">v</span>, sig.<span class="property">r</span>, sig.<span class="property">s</span>) == order.<span class="property">maker</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤–éƒ¨è´¦æˆ·ç­¾åã€ç¬¬ä¸‰æ–¹éªŒè¯ç­¾åçš„æœ‰æ•ˆæ€§è¿™ä¸ªè¿‡ç¨‹æœ¬èº«æ˜¯éå¸¸ç®€å•çš„ã€‚å¯¹äºåˆçº¦è´¦æˆ·è€Œè¨€ï¼Œå¹¶ä¸å…·å¤‡æœ‰ç§é’¥ï¼Œä¹Ÿæ— æ³•å®Œæˆæ•°æ®çš„å¸¸è§„ç­¾åã€‚ </p>
<h3 id="3-EIP1271"><a href="#3-EIP1271" class="headerlink" title="3. EIP1271"></a>3. EIP1271</h3><p><strong><strong><a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-1271">EIP1271</a>  å°±æ˜¯ä¸ºåˆçº¦æä¾›ç­¾åå’ŒéªŒè¯çš„æ ‡å‡†ã€‚</strong></strong> å®ƒçš„æ ‡å‡†æ¥å£ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.5</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">ERC1271</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bytes4(keccak256(&quot;isValidSignature(bytes32,bytes)&quot;)</span></span><br><span class="line">  bytes4 constant internal <span class="variable constant_">MAGICVALUE</span> = <span class="number">0x1626ba7e</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev</span> Should return whether the signature provided is valid for the provided hash</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> _hash      Hash of the data to be signed</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> _signature Signature byte array associated with _hash</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * MUST return the bytes4 magic value 0x1626ba7e when function passes.</span></span><br><span class="line"><span class="comment">   * MUST NOT modify state (using STATICCALL for solc &lt; 0.5, view modifier for solc &gt; 0.5)</span></span><br><span class="line"><span class="comment">   * MUST allow external calls</span></span><br><span class="line"><span class="comment">   */</span> </span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">isValidSignature</span>(<span class="params"></span></span><br><span class="line"><span class="params">    bytes32 _hash, </span></span><br><span class="line"><span class="params">    bytes memory _signature</span>)</span><br><span class="line">    public</span><br><span class="line">    view </span><br><span class="line">    returns (bytes4 magicValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯çŸ¥ï¼Œå…·ä½“çš„éªŒè¯è¿‡ç¨‹ï¼Œå®é™…ä¸Šæ˜¯åœ¨ <code>isValidSignature</code> ä¸­å®Œæˆçš„ï¼Œå¦‚æœéªŒè¯è¿‡ç¨‹é€šè¿‡ï¼Œæœ€ç»ˆåº”å½“è¿”å›è¿™ä¸ªé­”æ•° <code>0x1626ba7e</code>ã€‚è¯¥æ–¹æ³•çš„å®ç°è€…ï¼Œé€šå¸¸æ˜¯ç­¾åçš„åˆçº¦æœ¬èº«ï¼Œå³ <strong><strong>è°ç­¾åè°éªŒè¯</strong></strong>ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ‰¾ä¸¤ä¸ªåˆçº¦å®ä¾‹çœ‹ã€‚<br>ç¬¬ä¸€ä¸ªæ¥è‡ªäºçˆ±æ­»æœºçš„<a target="_blank" rel="noopener" href="https://etherscan.io/address/0xfd43d1da000558473822302e1d44d81da2e4cc0d#code">åˆçº¦</a>ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isSignatureValid</span>(<span class="params">uint256 _category, bytes memory _signature</span>)</span><br><span class="line">internal</span><br><span class="line">view</span><br><span class="line">returns (bool)</span><br><span class="line">&#123;</span><br><span class="line">    bytes32 result = <span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(msg.<span class="property">sender</span>, _category));</span><br><span class="line">    bytes32 hash = <span class="title function_">keccak256</span>(abi.<span class="title function_">encodePacked</span>(<span class="string">&quot;\x19Ethereum Signed Message:\n32&quot;</span>, result));</span><br><span class="line">    <span class="keyword">return</span> signer.<span class="title function_">isValidSignatureNow</span>(hash, _signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ EIP1271 å®ç°ï¼Œä½†æ˜¯æ€è·¯ä¸Šå…·æœ‰ä¸€è‡´æ€§ï¼Œå‡æ˜¯é€šè¿‡çº¿ä¸‹ç”±ç¬¬ä¸‰æ–¹ç­¾åï¼Œçº¿ä¸Šç”±ç¬¬ä¸‰æ–¹éªŒè¯çš„è¿‡ç¨‹ã€‚<br>ç”¨æˆ·åœ¨çº¿ä¸‹ï¼Œï¼ˆé€šè¿‡ http è®¿é—®ï¼‰å‘ç¬¬ä¸‰æ–¹è·å–åˆ°ç­¾åï¼Œå¹¶å‘åˆçº¦æäº¤è¯¥ç­¾åï¼Œæœ€ç»ˆï¼Œåœ¨åˆçº¦ä¸­éªŒè¯ç­¾åçš„æœ‰æ•ˆæ€§ã€‚<br>è¿™é‡Œï¼Œçº¿ä¸‹ç­¾åå’Œç­¾ç½²è€…å’Œçº¿ä¸Šç­¾åçš„éªŒè¯è€…ï¼Œåº”æ˜¯åŒä¸€ä¸ªè´¦æˆ·ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œå†çœ‹ä¸€ä¸ªæ¥è‡ª Gonisis ä¸­ <a target="_blank" rel="noopener" href="https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/handler/CompatibilityFallbackHandler.sol#L28">CompatibilityFallbackHandler</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Implementation of ISignatureValidator (see `interfaces/ISignatureValidator.sol`)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev</span> Should return whether the signature provided is valid for the provided data.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> _data Arbitrary length data signed on the behalf of address(msg.sender)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> _signature Signature byte array associated with _data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a bool upon valid or invalid signature with corresponding _data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isValidSignature</span>(<span class="params">bytes calldata _data, bytes calldata _signature</span>) public view override returns (bytes4) &#123;</span><br><span class="line">    <span class="comment">// Caller should be a Safe</span></span><br><span class="line">    <span class="title class_">GnosisSafe</span> safe = <span class="title class_">GnosisSafe</span>(<span class="title function_">payable</span>(msg.<span class="property">sender</span>));</span><br><span class="line">    bytes32 messageHash = <span class="title function_">getMessageHashForSafe</span>(safe, _data);</span><br><span class="line">    <span class="keyword">if</span> (_signature.<span class="property">length</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(safe.<span class="title function_">signedMessages</span>(messageHash) != <span class="number">0</span>, <span class="string">&quot;Hash not approved&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        safe.<span class="title function_">checkSignatures</span>(messageHash, _data, _signature);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">EIP1271</span>_MAGIC_VALUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œï¼Œè°ƒç”¨è€…éœ€è¦æ˜¯ Gnosisï¼Œå°†ä¼šæ£€æŸ¥ Gnosis ä¸­æ˜¯å¦å·²ç»è®°å½•äº†ç‰¹å®šæ¶ˆæ¯çš„ç­¾åï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¡¨ç¤ºéªŒè¯é€šè¿‡ï¼Œå¦åˆ™ä¸é€šè¿‡ã€‚</p>
<br/>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/EIP/">EIP</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/EIP712/">EIP712</a><a href="/tags/EIP1271/">EIP1271</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    
    &copy; 2025 YueGS
    
  </p>
</footer>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-116967169-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-116967169-1');
</script>

    
  </div>
</div>
</body>
</html>