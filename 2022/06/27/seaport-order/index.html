<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Seaport - Order | 风雪围城</title>

  
  <meta name="author" content="YueGS">
  

  
  <meta name="description" content="Seaport 是 OpenSea 下一代交易协议。本文讨论 Seaport 版本 1.1.0 中 Order 实体&amp;#x2F; Order Hash&amp;#x2F; Order 签名过程以及 Order 创建，为下一篇 fulfill order 做准备。">
  

  
  
  <meta name="keywords" content="Seaport,智能合约,Order,OpenSea">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Seaport - Order"/>

  <meta property="og:site_name" content="风雪围城"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="风雪围城" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">风雪围城</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/about">About</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Seaport - Order</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2022/06/27/seaport-order/" rel="bookmark">
        <time class="entry-date published" datetime="2022-06-27T12:06:06.000Z">
          2022-06-27
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p><img src="https://raw.githubusercontent.com/yuegs/yuegs.github.io/master/images/smart-contract/seaport/order/seaport-order.png"></p>
<p>Seaport 是 OpenSea 下一代交易协议。<br>本文讨论 <a target="_blank" rel="noopener" href="https://github.com/ProjectOpenSea/seaport/tree/zones-1.1">Seaport 版本 1.1.0</a> 中 Order 实体&#x2F; Order Hash&#x2F; Order 签名过程以及 Order 创建，为下一篇 fulfill order 做准备。</p>
<span id="more"></span>
<h3 id="1-Order-以及-AdvancedOrder-的数据结构"><a href="#1-Order-以及-AdvancedOrder-的数据结构" class="headerlink" title="1. Order 以及 AdvancedOrder 的数据结构"></a>1. Order 以及 AdvancedOrder 的数据结构</h3><h4 id="Order"><a href="#Order" class="headerlink" title="Order"></a>Order</h4><p>订单实体</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct <span class="title class_">Order</span> &#123;</span><br><span class="line">    <span class="comment">// 订单参数</span></span><br><span class="line">    <span class="title class_">OrderParameters</span> parameters;</span><br><span class="line">    <span class="comment">// 订单签名</span></span><br><span class="line">    bytes signature;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>订单参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">struct <span class="title class_">OrderParameters</span> &#123;</span><br><span class="line">    <span class="comment">// 报价人，供应内容放在 offer 中</span></span><br><span class="line">    address offerer; <span class="comment">// 0x00  </span></span><br><span class="line">    <span class="comment">// 辅助账户。在严格交易模式下，交易的发起者应当是 offerer、zone 或者 zone 的授权账户（通过 EIP1271验证）</span></span><br><span class="line">    <span class="comment">// 这个账户的第二个作用在于，它可以取消交易</span></span><br><span class="line">    address zone; <span class="comment">// 0x20 </span></span><br><span class="line">    <span class="comment">// offerer 账户中要转移的对象</span></span><br><span class="line">    <span class="title class_">OfferItem</span>[] offer; <span class="comment">// 0x40</span></span><br><span class="line">    <span class="comment">// 对价</span></span><br><span class="line">    <span class="title class_">ConsiderationItem</span>[] consideration; <span class="comment">// 0x60</span></span><br><span class="line">    <span class="comment">// 是否可以部分交易；是否任何人都可以执行订单的调用</span></span><br><span class="line">    <span class="title class_">OrderType</span> orderType; <span class="comment">// 0x80   订单类型</span></span><br><span class="line">    <span class="comment">// 订单被激活时的区块上时间戳</span></span><br><span class="line">    uint256 startTime; <span class="comment">// 0xa0</span></span><br><span class="line">    <span class="comment">// 订单结束时的区块上时间戳</span></span><br><span class="line">    uint256 endTime; <span class="comment">// 0xc0</span></span><br><span class="line">    <span class="comment">// EIP1271 验证时需要的字段</span></span><br><span class="line">    bytes32 zoneHash; <span class="comment">// 0xe0</span></span><br><span class="line">    <span class="comment">// 熵增</span></span><br><span class="line">    uint256 salt; <span class="comment">// 0x100</span></span><br><span class="line">    bytes32 conduitKey; <span class="comment">// 0x120</span></span><br><span class="line">    <span class="comment">// 交易需要满足 offerer  的 counter</span></span><br><span class="line">    uint256 totalOriginalConsiderationItems; <span class="comment">// 0x140</span></span><br><span class="line">    <span class="comment">// offer.length                          // 0x160</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>订单参数中，offer 数组的元素类型为 OfferItem，表示可从 offerer 账户中转移的对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct <span class="title class_">OfferItem</span> &#123;</span><br><span class="line">    <span class="comment">// 0: ETH on mainnet, MATIC on polygon, etc. 1: ERC20 items 2: ERC721 items</span></span><br><span class="line">    <span class="comment">// 3: ERC1155 items  4: ERC721 items where a number of tokenIds are supported</span></span><br><span class="line">    <span class="comment">// 5: ERC1155 items where a number of ids are supported</span></span><br><span class="line">    <span class="title class_">ItemType</span> itemType;</span><br><span class="line">    <span class="comment">// item token 合约地址</span></span><br><span class="line">    address token;</span><br><span class="line">    <span class="comment">// erc721/erc1155 token id；对于 criteria-based item，是 merkle root；对于 ERC20 或者 Ether，该值没有意义</span></span><br><span class="line">    uint256 identifierOrCriteria;</span><br><span class="line">    <span class="comment">// 开始时的金额</span></span><br><span class="line">    uint256 startAmount;</span><br><span class="line">    <span class="comment">// 结束时的金额，从开始到结束的金额，是线性变化的</span></span><br><span class="line">    uint256 endAmount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>订单参数中，consideration 数组中元素的类型为 ConsiderationItem,表示与 Offer 相对应的对价。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct <span class="title class_">ConsiderationItem</span> &#123;</span><br><span class="line">    <span class="title class_">ItemType</span> itemType;</span><br><span class="line">    address token;</span><br><span class="line">    uint256 identifierOrCriteria;</span><br><span class="line">    uint256 startAmount;</span><br><span class="line">    uint256 endAmount;</span><br><span class="line">    <span class="comment">// 注意，和 OfferItem 不同，这里多了一个 recipient。</span></span><br><span class="line">    <span class="comment">// 对应着 item 的接收地址</span></span><br><span class="line">    address payable recipient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Order 类型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">enum <span class="title class_">OrderType</span> &#123;</span><br><span class="line">    <span class="comment">// 0: no partial fills, anyone can execute</span></span><br><span class="line">    <span class="variable constant_">FULL_OPEN</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1: partial fills supported, anyone can execute</span></span><br><span class="line">    <span class="variable constant_">PARTIAL_OPEN</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2: no partial fills, only offerer or zone can execute</span></span><br><span class="line">    <span class="variable constant_">FULL_RESTRICTED</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3: partial fills supported, only offerer or zone can execute</span></span><br><span class="line">    <span class="variable constant_">PARTIAL_RESTRICTED</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Order 状态</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct <span class="title class_">OrderStatus</span> &#123;</span><br><span class="line">    bool isValidated;</span><br><span class="line">    bool isCancelled;</span><br><span class="line">    uint120 numerator;</span><br><span class="line">    uint120 denominator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AdvancedOrder"><a href="#AdvancedOrder" class="headerlink" title="AdvancedOrder"></a>AdvancedOrder</h4><p>高级订单中，不仅包括了 Order，还包括了 <code>numerator</code> 和 <code>denominator</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct <span class="title class_">AdvancedOrder</span> &#123;</span><br><span class="line">    <span class="title class_">OrderParameters</span> parameters;</span><br><span class="line">    <span class="comment">// a fraction to attempt to fill</span></span><br><span class="line">    uint120 numerator;</span><br><span class="line">    <span class="comment">// the total size of the order</span></span><br><span class="line">    uint120 denominator;</span><br><span class="line">    bytes signature;</span><br><span class="line">    bytes extraData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 <code>numerator</code> 和 <code>denominator</code> 两个参数其实是不易让人理解的，不过，可以通过这两个参数的具体应用来了解它们，可以看到其主要用于 amount 的计算过程：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AmountDeriver.sol</span></span><br><span class="line"><span class="comment">// 如果是 ether 或者其它 erc20，返回的 amount 代表金额；</span></span><br><span class="line"><span class="comment">// 如果 item 基于 erc721 协议，返回的 amount 应当是 1；</span></span><br><span class="line"><span class="comment">// 如果 item 基于 erc1155 协议，返回的 amount 代表的是某个 nft 的数量</span></span><br><span class="line"><span class="comment">// @param startAmount，订单初始价格；</span></span><br><span class="line"><span class="comment">// @param endAmount，订单结束时的价格；</span></span><br><span class="line"><span class="comment">// @param numberator 分子；</span></span><br><span class="line"><span class="comment">// @param denominator 分母； </span></span><br><span class="line"><span class="comment">// numberator/denominator 实际上代表了在交易内容符合 erc1155 或者 erc20 协议时，交换者希望兑换的某一对象的份额</span></span><br><span class="line"><span class="comment">// @param startTime 订单开始的时间；</span></span><br><span class="line"><span class="comment">// @param endTime 订单结束的时间；</span></span><br><span class="line"><span class="comment">// @param roundUp 结果是向上还是向下取整</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_applyFraction</span>(<span class="params"></span></span><br><span class="line"><span class="params">    uint256 startAmount,</span></span><br><span class="line"><span class="params">    uint256 endAmount,</span></span><br><span class="line"><span class="params">    uint256 numerator,</span></span><br><span class="line"><span class="params">    uint256 denominator,</span></span><br><span class="line"><span class="params">    uint256 startTime,</span></span><br><span class="line"><span class="params">    uint256 endTime,</span></span><br><span class="line"><span class="params">    bool roundUp</span></span><br><span class="line"><span class="params"></span>) internal view returns (uint256 amount) &#123;</span><br><span class="line">    <span class="comment">// 固定价格</span></span><br><span class="line">    <span class="keyword">if</span> (startAmount == endAmount) &#123;</span><br><span class="line">        <span class="comment">// Apply fraction to end amount.</span></span><br><span class="line">        amount = <span class="title function_">_getFraction</span>(numerator, denominator, endAmount);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 基于数量和时间的浮动价格</span></span><br><span class="line">        amount = <span class="title function_">_locateCurrentAmount</span>(</span><br><span class="line">            <span class="title function_">_getFraction</span>(numerator, denominator, startAmount),</span><br><span class="line">            <span class="title function_">_getFraction</span>(numerator, denominator, endAmount),</span><br><span class="line">            startTime,</span><br><span class="line">            endTime,</span><br><span class="line">            roundUp</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_getFraction</span>(<span class="params"></span></span><br><span class="line"><span class="params">    uint256 numerator,</span></span><br><span class="line"><span class="params">    uint256 denominator,</span></span><br><span class="line"><span class="params">    uint256 value</span></span><br><span class="line"><span class="params"></span>) internal pure returns (uint256 newValue) &#123;</span><br><span class="line">    <span class="comment">// 分子分母相同，不存在比例问题</span></span><br><span class="line">    <span class="keyword">if</span> (numerator == denominator) &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// that the denominator cannot be zero.</span></span><br><span class="line">    assembly &#123;</span><br><span class="line">        <span class="comment">// 确保 (value * numerator) % denominator 没有剩余</span></span><br><span class="line">        <span class="comment">// 没有 半个 erc1155 nft；也没有半个 erc20，对于 erc20 已经是最小单位了。</span></span><br><span class="line">        <span class="comment">// 数量均无法再次分割。</span></span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">mulmod</span>(<span class="params">value, numerator, denominator</span>) &#123;</span><br><span class="line">            <span class="title function_">mstore</span>(<span class="number">0</span>, <span class="title class_">InexactFraction</span>_error_signature)</span><br><span class="line">            <span class="title function_">revert</span>(<span class="number">0</span>, <span class="title class_">InexactFraction</span>_error_len)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Multiply the numerator by the value and ensure no overflow occurs.</span></span><br><span class="line">    uint256 valueTimesNumerator = value * numerator;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所以，实际上就是 ：value = value * numerator / denominator</span></span><br><span class="line">    assembly &#123;</span><br><span class="line">        <span class="comment">// 这里没有对 denominator 是否为 0 做判断</span></span><br><span class="line">        newValue := <span class="title function_">div</span>(valueTimesNumerator, denominator)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_locateCurrentAmount</span>(<span class="params"></span></span><br><span class="line"><span class="params">    uint256 startAmount,</span></span><br><span class="line"><span class="params">    uint256 endAmount,</span></span><br><span class="line"><span class="params">    uint256 startTime,</span></span><br><span class="line"><span class="params">    uint256 endTime,</span></span><br><span class="line"><span class="params">    bool roundUp</span></span><br><span class="line"><span class="params"></span>) internal view returns (uint256 amount) &#123;</span><br><span class="line">    <span class="comment">// Only modify end amount if it doesn&#x27;t already equal start amount.</span></span><br><span class="line">    <span class="keyword">if</span> (startAmount != endAmount) &#123;</span><br><span class="line">        <span class="comment">// 订单有效时间长度</span></span><br><span class="line">        uint256 duration;</span><br><span class="line">        <span class="comment">// 订单已经过去的时间</span></span><br><span class="line">        uint256 elapsed;</span><br><span class="line">        <span class="comment">// 剩余的订单有效时长</span></span><br><span class="line">        uint256 remaining;</span><br><span class="line"></span><br><span class="line">        unchecked &#123;</span><br><span class="line">            duration = endTime - startTime;</span><br><span class="line">            elapsed = block.<span class="property">timestamp</span> - startTime;</span><br><span class="line">            remaining = duration - elapsed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// totalBeforeDivision/duration 得到最终值</span></span><br><span class="line">        uint256 totalBeforeDivision = ((startAmount * remaining) +</span><br><span class="line">            (endAmount * elapsed));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use assembly to combine operations and skip divide-by-zero check.</span></span><br><span class="line">        assembly &#123;</span><br><span class="line">            <span class="comment">// Multiply by iszero(iszero(totalBeforeDivision)) to ensure</span></span><br><span class="line">            <span class="comment">// amount is set to zero if totalBeforeDivision is zero,</span></span><br><span class="line">            <span class="comment">// as intermediate overflow can occur if it is zero.</span></span><br><span class="line">            amount := <span class="title function_">mul</span>(</span><br><span class="line">                <span class="comment">// iszero(x) 1 if x == 0, 0 otherwise</span></span><br><span class="line">                <span class="title function_">iszero</span>(<span class="title function_">iszero</span>(totalBeforeDivision)),</span><br><span class="line">                <span class="comment">// 取整策略</span></span><br><span class="line">                <span class="title function_">add</span>(</span><br><span class="line">                    <span class="title function_">div</span>(<span class="title function_">sub</span>(totalBeforeDivision, roundUp), duration),</span><br><span class="line">                    roundUp</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Return the current amount.</span></span><br><span class="line">        <span class="keyword">return</span> amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the original amount as startAmount == endAmount.</span></span><br><span class="line">    <span class="keyword">return</span> endAmount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际的交易过程如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; totalOfferItems; ++i) &#123;</span><br><span class="line">  ...</span><br><span class="line"><span class="comment">// 获取当前检索的 OfferItem</span></span><br><span class="line">  <span class="title class_">OfferItem</span> memory offerItem = orderParameters.<span class="property">offer</span>[i];</span><br><span class="line">  uint256 amount = <span class="title function_">_applyFraction</span>(</span><br><span class="line">        offerItem.<span class="property">startAmount</span>,</span><br><span class="line">        offerItem.<span class="property">endAmount</span>,</span><br><span class="line">        numerator,</span><br><span class="line">        denominator,</span><br><span class="line">        startTime,</span><br><span class="line">        endTime,</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    );</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 价值转移</span></span><br><span class="line">  <span class="title function_">_transferOfferItem</span>(</span><br><span class="line">      offerItem,  <span class="comment">// item</span></span><br><span class="line">      orderParameters.<span class="property">offerer</span>,  <span class="comment">// from</span></span><br><span class="line">      orderParameters.<span class="property">conduitKey</span>,  <span class="comment">//  conduitKey</span></span><br><span class="line">      accumulator  <span class="comment">// accumulator</span></span><br><span class="line">  );</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据不同的 ItemType，结合 amount，完成资产转移：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 _transferOfferItem 执行体内完成最后的价值转移 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果 ItemType 为 ItemType.NATIVE</span></span><br><span class="line"><span class="title function_">_transferEth</span>(item.<span class="property">recipient</span>, item.<span class="property">amount</span>);</span><br><span class="line"><span class="comment">// 如果 ItemType 为 ItemType.ERC20</span></span><br><span class="line"><span class="title function_">_transferERC20</span>(item.<span class="property">token</span>,<span class="keyword">from</span>,item.<span class="property">recipient</span>,item.<span class="property">amount</span>,conduitKey, accumulator);</span><br><span class="line"><span class="comment">// 如果 ItemType 为 ItemType.ERC721，这种情况下，amount 应为 1</span></span><br><span class="line"><span class="title function_">_transferERC721</span>(item.<span class="property">token</span>,<span class="keyword">from</span>,item.<span class="property">recipient</span>,item.<span class="property">identifier</span>,item.<span class="property">amount</span>,conduitKey,accumulator);</span><br><span class="line"><span class="comment">// 如果 ItemType 为 ItemType.ERC1155</span></span><br><span class="line"><span class="title function_">_transferERC1155</span>( item.<span class="property">token</span>, <span class="keyword">from</span>,item.<span class="property">recipient</span>,item.<span class="property">identifier</span>, item.<span class="property">amount</span>,conduitKey,accumulator);</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="2-订单-Hash"><a href="#2-订单-Hash" class="headerlink" title="2. 订单 Hash"></a>2. 订单 Hash</h3><p>ts 版本如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">calculateOrderHash</span> = (<span class="params">orderComponents: OrderComponents</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> offerItemTypeString =</span><br><span class="line">    <span class="string">&quot;OfferItem(uint8 itemType,address token,uint256 identifierOrCriteria,uint256 startAmount,uint256 endAmount)&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> considerationItemTypeString =</span><br><span class="line">    <span class="string">&quot;ConsiderationItem(uint8 itemType,address token,uint256 identifierOrCriteria,uint256 startAmount,uint256 endAmount,address recipient)&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> orderComponentsPartialTypeString =</span><br><span class="line">    <span class="string">&quot;OrderComponents(address offerer,address zone,OfferItem[] offer,ConsiderationItem[] consideration,uint8 orderType,uint256 startTime,uint256 endTime,bytes32 zoneHash,uint256 salt,bytes32 conduitKey,uint256 counter)&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> orderTypeString = <span class="string">`<span class="subst">$&#123;orderComponentsPartialTypeString&#125;</span><span class="subst">$&#123;considerationItemTypeString&#125;</span><span class="subst">$&#123;offerItemTypeString&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> offerItemTypeHash = <span class="title function_">keccak256</span>(<span class="title function_">toUtf8Bytes</span>(offerItemTypeString));</span><br><span class="line">  <span class="keyword">const</span> considerationItemTypeHash = <span class="title function_">keccak256</span>(</span><br><span class="line">    <span class="title function_">toUtf8Bytes</span>(considerationItemTypeString)</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> orderTypeHash = <span class="title function_">keccak256</span>(<span class="title function_">toUtf8Bytes</span>(orderTypeString));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算 offer 的 Hash</span></span><br><span class="line">  <span class="keyword">const</span> offerHash = <span class="title function_">keccak256</span>(</span><br><span class="line">    <span class="string">&quot;0x&quot;</span> +</span><br><span class="line">      orderComponents.<span class="property">offer</span></span><br><span class="line">        .<span class="title function_">map</span>(<span class="function">(<span class="params">offerItem</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">keccak256</span>(</span><br><span class="line">            <span class="string">&quot;0x&quot;</span> +</span><br><span class="line">              [</span><br><span class="line">                offerItemTypeHash.<span class="title function_">slice</span>(<span class="number">2</span>),</span><br><span class="line">                offerItem.<span class="property">itemType</span>.<span class="title function_">toString</span>().<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">                offerItem.<span class="property">token</span>.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">                <span class="title function_">toBN</span>(offerItem.<span class="property">identifierOrCriteria</span>)</span><br><span class="line">                  .<span class="title function_">toHexString</span>()</span><br><span class="line">                  .<span class="title function_">slice</span>(<span class="number">2</span>)</span><br><span class="line">                  .<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">                <span class="title function_">toBN</span>(offerItem.<span class="property">startAmount</span>)</span><br><span class="line">                  .<span class="title function_">toHexString</span>()</span><br><span class="line">                  .<span class="title function_">slice</span>(<span class="number">2</span>)</span><br><span class="line">                  .<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">                <span class="title function_">toBN</span>(offerItem.<span class="property">endAmount</span>)</span><br><span class="line">                  .<span class="title function_">toHexString</span>()</span><br><span class="line">                  .<span class="title function_">slice</span>(<span class="number">2</span>)</span><br><span class="line">                  .<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">              ].<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">          ).<span class="title function_">slice</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算 consideration 的 Hash</span></span><br><span class="line">  <span class="keyword">const</span> considerationHash = <span class="title function_">keccak256</span>(</span><br><span class="line">    <span class="string">&quot;0x&quot;</span> +</span><br><span class="line">      orderComponents.<span class="property">consideration</span></span><br><span class="line">        .<span class="title function_">map</span>(<span class="function">(<span class="params">considerationItem</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">keccak256</span>(</span><br><span class="line">            <span class="string">&quot;0x&quot;</span> +</span><br><span class="line">              [</span><br><span class="line">                considerationItemTypeHash.<span class="title function_">slice</span>(<span class="number">2</span>),</span><br><span class="line">                considerationItem.<span class="property">itemType</span>.<span class="title function_">toString</span>().<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">                considerationItem.<span class="property">token</span>.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">                <span class="title function_">toBN</span>(considerationItem.<span class="property">identifierOrCriteria</span>)</span><br><span class="line">                  .<span class="title function_">toHexString</span>()</span><br><span class="line">                  .<span class="title function_">slice</span>(<span class="number">2</span>)</span><br><span class="line">                  .<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">                <span class="title function_">toBN</span>(considerationItem.<span class="property">startAmount</span>)</span><br><span class="line">                  .<span class="title function_">toHexString</span>()</span><br><span class="line">                  .<span class="title function_">slice</span>(<span class="number">2</span>)</span><br><span class="line">                  .<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">                <span class="title function_">toBN</span>(considerationItem.<span class="property">endAmount</span>)</span><br><span class="line">                  .<span class="title function_">toHexString</span>()</span><br><span class="line">                  .<span class="title function_">slice</span>(<span class="number">2</span>)</span><br><span class="line">                  .<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">                considerationItem.<span class="property">recipient</span>.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">              ].<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">          ).<span class="title function_">slice</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">  );</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ① Hash( 数据类型 Hash + 数据内容)。</span></span><br><span class="line">  <span class="comment">// ② 如果数据内容是数组，则 Hash(拼接(数据类型 Hash + 数据内容(i)))</span></span><br><span class="line">  <span class="comment">// ③ 如果数据内容中包含复合结构，则通过 ① 或者 ② 获取到该数据项的 Hash 代替该数据</span></span><br><span class="line">  <span class="keyword">const</span> derivedOrderHash = <span class="title function_">keccak256</span>(</span><br><span class="line">    <span class="string">&quot;0x&quot;</span> +</span><br><span class="line">      [</span><br><span class="line">        orderTypeHash.<span class="title function_">slice</span>(<span class="number">2</span>), <span class="comment">// 数据类型的 Hash</span></span><br><span class="line">        orderComponents.<span class="property">offerer</span>.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">        orderComponents.<span class="property">zone</span>.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">        offerHash.<span class="title function_">slice</span>(<span class="number">2</span>),</span><br><span class="line">        considerationHash.<span class="title function_">slice</span>(<span class="number">2</span>),</span><br><span class="line">        orderComponents.<span class="property">orderType</span>.<span class="title function_">toString</span>().<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">        <span class="title function_">toBN</span>(orderComponents.<span class="property">startTime</span>)</span><br><span class="line">          .<span class="title function_">toHexString</span>()</span><br><span class="line">          .<span class="title function_">slice</span>(<span class="number">2</span>)</span><br><span class="line">          .<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">        <span class="title function_">toBN</span>(orderComponents.<span class="property">endTime</span>).<span class="title function_">toHexString</span>().<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">        orderComponents.<span class="property">zoneHash</span>.<span class="title function_">slice</span>(<span class="number">2</span>),</span><br><span class="line">        orderComponents.<span class="property">salt</span>.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">        orderComponents.<span class="property">conduitKey</span>.<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">        <span class="title function_">toBN</span>(orderComponents.<span class="property">counter</span>).<span class="title function_">toHexString</span>().<span class="title function_">slice</span>(<span class="number">2</span>).<span class="title function_">padStart</span>(<span class="number">64</span>, <span class="string">&quot;0&quot;</span>),</span><br><span class="line">      ].<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> derivedOrderHash;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>sol 版本如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">_deriveOrderHash</span>(<span class="params"></span></span><br><span class="line"><span class="params">    OrderParameters memory orderParameters,</span></span><br><span class="line"><span class="params">    uint256 counter</span></span><br><span class="line"><span class="params"></span>) internal view returns (bytes32 orderHash) &#123;</span><br><span class="line">    <span class="comment">// Get length of original consideration array and place it on the stack.</span></span><br><span class="line">    uint256 originalConsiderationLength = (</span><br><span class="line">        orderParameters.<span class="property">totalOriginalConsiderationItems</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Memory layout for an array of structs (dynamic or not) is similar</span></span><br><span class="line"><span class="comment">     * to ABI encoding of dynamic types, with a head segment followed by</span></span><br><span class="line"><span class="comment">     * a data segment. The main difference is that the head of an element</span></span><br><span class="line"><span class="comment">     * is a memory pointer rather than an offset.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// Declare a variable for the derived hash of the offer array.</span></span><br><span class="line">    bytes32 offerHash;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read offer item EIP-712 typehash from runtime code &amp; place on stack.</span></span><br><span class="line">    bytes32 typeHash = _OFFER_ITEM_TYPEHASH;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Utilize assembly so that memory regions can be reused across hashes.</span></span><br><span class="line">    assembly &#123;</span><br><span class="line">        <span class="comment">// FreeMemoryPointerSlot = 0x40;</span></span><br><span class="line">        <span class="comment">// m:=mload(0x40) instruction reads the 32 bytes of memory starting at position 0x40.</span></span><br><span class="line">        <span class="comment">// Retrieve the free memory pointer and place on the stack.</span></span><br><span class="line">        <span class="keyword">let</span> hashArrPtr := <span class="title function_">mload</span>(<span class="title class_">FreeMemoryPointerSlot</span>)</span><br><span class="line">        <span class="comment">// Get the pointer to the offers array.</span></span><br><span class="line">        <span class="keyword">let</span> offerArrPtr := <span class="title function_">mload</span>(</span><br><span class="line">            <span class="comment">// OrderParameters_offer_head_offset = 0x40;</span></span><br><span class="line">            <span class="comment">// 跨过前面的 offerer 和 zone，这两个数据都是 address 类型，占 64 字节</span></span><br><span class="line">            <span class="comment">// 之后，就是 offer 数组</span></span><br><span class="line">            <span class="title function_">add</span>(orderParameters, <span class="title class_">OrderParameters</span>_offer_head_offset)</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// Load the length.数组的长度</span></span><br><span class="line">        <span class="keyword">let</span> offerLength := <span class="title function_">mload</span>(offerArrPtr)</span><br><span class="line">        <span class="comment">// Set the pointer to the first offer&#x27;s head.</span></span><br><span class="line">        <span class="comment">// OneWord = 0x20;</span></span><br><span class="line">        <span class="comment">// offer 数组的 OneWord，表示数组的长度</span></span><br><span class="line">        <span class="comment">// 跨过 OneWord，则达到实际数组存储的位置</span></span><br><span class="line">        offerArrPtr := <span class="title function_">add</span>(offerArrPtr, <span class="title class_">OneWord</span>)</span><br><span class="line">        <span class="comment">// Iterate over the offer items.prettier-ignore</span></span><br><span class="line">        <span class="comment">// https://solidity-cn.readthedocs.io/zh/develop/assembly.html#id11</span></span><br><span class="line">        <span class="comment">// 内联汇编中的 for 循环：初始化部分、条件和迭代后处理部分. lt(x, y) 如果 x &lt; y 为 1，否则为 0</span></span><br><span class="line">        <span class="keyword">for</span> &#123; <span class="keyword">let</span> i := <span class="number">0</span> &#125; <span class="title function_">lt</span>(<span class="params">i, offerLength</span>) &#123;</span><br><span class="line">            i := <span class="title function_">add</span>(i, <span class="number">1</span>)</span><br><span class="line">        &#125; &#123;</span><br><span class="line">            <span class="comment">// Read the pointer to the offer data and subtract one word to get typeHash pointer.</span></span><br><span class="line">            <span class="comment">// mload(p) -&gt; mem[p...(p + 32))]</span></span><br><span class="line">            <span class="keyword">let</span> ptr := <span class="title function_">sub</span>(<span class="title function_">mload</span>(offerArrPtr), <span class="title class_">OneWord</span>)</span><br><span class="line">            <span class="comment">// Read the current value before the offer data. mload(p) -&gt; mem[p...(p + 32))]</span></span><br><span class="line">            <span class="comment">// 这里临时解用 ptr 所指向的 32 位空间，后面再把 value 还原回去</span></span><br><span class="line">            <span class="keyword">let</span> value := <span class="title function_">mload</span>(ptr)</span><br><span class="line">            <span class="comment">// Write the type hash to the previous word. mstore(p, v) -&gt; mem[p...(p + 32)] := v</span></span><br><span class="line">            <span class="title function_">mstore</span>(ptr, typeHash)</span><br><span class="line">            <span class="comment">// Take the EIP712 hash and store it in the hash array. EIP712_OfferItem_size = 0xc0;</span></span><br><span class="line">            <span class="comment">// 在 hashAddrPtr 上存储单个 item 的哈希值</span></span><br><span class="line">            <span class="title function_">mstore</span>(hashArrPtr, <span class="title function_">keccak256</span>(ptr, <span class="title class_">EIP712</span>_OfferItem_size))</span><br><span class="line">            <span class="comment">// Restore the previous word.</span></span><br><span class="line">            <span class="comment">// 我们临时借用了 ptr 出的 32 位空间，现在把它还回去 ！！！</span></span><br><span class="line">            <span class="title function_">mstore</span>(ptr, value)</span><br><span class="line">            <span class="comment">// Increment the array pointers by one word.</span></span><br><span class="line">            offerArrPtr := <span class="title function_">add</span>(offerArrPtr, <span class="title class_">OneWord</span>)</span><br><span class="line">            <span class="comment">// hashArrPtr 前移 32 个位</span></span><br><span class="line">            hashArrPtr := <span class="title function_">add</span>(hashArrPtr, <span class="title class_">OneWord</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Derive the offer hash using the hashes of each item.</span></span><br><span class="line">        offerHash := <span class="title function_">keccak256</span>(</span><br><span class="line">            <span class="title function_">mload</span>(<span class="title class_">FreeMemoryPointerSlot</span>),</span><br><span class="line">            <span class="title function_">mul</span>(offerLength, <span class="title class_">OneWord</span>)</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Declare a variable for the derived hash of the consideration array.</span></span><br><span class="line">    bytes32 considerationHash;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read consideration item typehash from runtime code &amp; place on stack.</span></span><br><span class="line">    typeHash = _CONSIDERATION_ITEM_TYPEHASH;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Utilize assembly so that memory regions can be reused across hashes.</span></span><br><span class="line">    assembly &#123;</span><br><span class="line">        <span class="comment">// Retrieve the free memory pointer and place on the stack.</span></span><br><span class="line">        <span class="keyword">let</span> hashArrPtr := <span class="title function_">mload</span>(<span class="title class_">FreeMemoryPointerSlot</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get the pointer to the consideration array.</span></span><br><span class="line">        <span class="keyword">let</span> considerationArrPtr := <span class="title function_">add</span>(</span><br><span class="line">            <span class="title function_">mload</span>(</span><br><span class="line">                <span class="title function_">add</span>(</span><br><span class="line">                    orderParameters,</span><br><span class="line">                    <span class="title class_">OrderParameters</span>_consideration_head_offset</span><br><span class="line">                )</span><br><span class="line">            ),</span><br><span class="line">            <span class="title class_">OneWord</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Iterate over the consideration items (not including tips).</span></span><br><span class="line">        <span class="comment">// prettier-ignore</span></span><br><span class="line">        <span class="keyword">for</span> &#123; <span class="keyword">let</span> i := <span class="number">0</span> &#125; <span class="title function_">lt</span>(<span class="params">i, originalConsiderationLength</span>) &#123;</span><br><span class="line">            i := <span class="title function_">add</span>(i, <span class="number">1</span>)</span><br><span class="line">        &#125; &#123;</span><br><span class="line">            <span class="comment">// Read the pointer to the consideration data and subtract one</span></span><br><span class="line">            <span class="comment">// word to get typeHash pointer.</span></span><br><span class="line">            <span class="keyword">let</span> ptr := <span class="title function_">sub</span>(<span class="title function_">mload</span>(considerationArrPtr), <span class="title class_">OneWord</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Read the current value before the consideration data.</span></span><br><span class="line">            <span class="keyword">let</span> value := <span class="title function_">mload</span>(ptr)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Write the type hash to the previous word.</span></span><br><span class="line">            <span class="title function_">mstore</span>(ptr, typeHash)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Take the EIP712 hash and store it in the hash array.</span></span><br><span class="line">            <span class="title function_">mstore</span>(</span><br><span class="line">                hashArrPtr,</span><br><span class="line">                <span class="title function_">keccak256</span>(ptr, <span class="title class_">EIP712</span>_ConsiderationItem_size)</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Restore the previous word.</span></span><br><span class="line">            <span class="title function_">mstore</span>(ptr, value)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Increment the array pointers by one word.</span></span><br><span class="line">            considerationArrPtr := <span class="title function_">add</span>(considerationArrPtr, <span class="title class_">OneWord</span>)</span><br><span class="line">            hashArrPtr := <span class="title function_">add</span>(hashArrPtr, <span class="title class_">OneWord</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Derive the consideration hash using the hashes of each item.</span></span><br><span class="line">        considerationHash := <span class="title function_">keccak256</span>(</span><br><span class="line">            <span class="title function_">mload</span>(<span class="title class_">FreeMemoryPointerSlot</span>),</span><br><span class="line">            <span class="title function_">mul</span>(originalConsiderationLength, <span class="title class_">OneWord</span>)</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read order item EIP-712 typehash from runtime code &amp; place on stack.</span></span><br><span class="line">    typeHash = _ORDER_TYPEHASH;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Utilize assembly to access derived hashes &amp; other arguments directly.</span></span><br><span class="line">    assembly &#123;</span><br><span class="line">        <span class="comment">// Retrieve pointer to the region located just behind parameters.</span></span><br><span class="line">        <span class="keyword">let</span> typeHashPtr := <span class="title function_">sub</span>(orderParameters, <span class="title class_">OneWord</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Store the value at that pointer location to restore later.</span></span><br><span class="line">        <span class="keyword">let</span> previousValue := <span class="title function_">mload</span>(typeHashPtr)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Store the order item EIP-712 typehash at the typehash location.</span></span><br><span class="line">        <span class="title function_">mstore</span>(typeHashPtr, typeHash)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Retrieve the pointer for the offer array head.</span></span><br><span class="line">        <span class="keyword">let</span> offerHeadPtr := <span class="title function_">add</span>(</span><br><span class="line">            orderParameters,</span><br><span class="line">            <span class="title class_">OrderParameters</span>_offer_head_offset</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Retrieve the data pointer referenced by the offer head.</span></span><br><span class="line">        <span class="keyword">let</span> offerDataPtr := <span class="title function_">mload</span>(offerHeadPtr)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Store the offer hash at the retrieved memory location.</span></span><br><span class="line">        <span class="title function_">mstore</span>(offerHeadPtr, offerHash)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Retrieve the pointer for the consideration array head.</span></span><br><span class="line">        <span class="keyword">let</span> considerationHeadPtr := <span class="title function_">add</span>(</span><br><span class="line">            orderParameters,</span><br><span class="line">            <span class="title class_">OrderParameters</span>_consideration_head_offset</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Retrieve the data pointer referenced by the consideration head.</span></span><br><span class="line">        <span class="keyword">let</span> considerationDataPtr := <span class="title function_">mload</span>(considerationHeadPtr)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Store the consideration hash at the retrieved memory location.</span></span><br><span class="line">        <span class="title function_">mstore</span>(considerationHeadPtr, considerationHash)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Retrieve the pointer for the counter.</span></span><br><span class="line">        <span class="keyword">let</span> counterPtr := <span class="title function_">add</span>(</span><br><span class="line">            orderParameters,</span><br><span class="line">            <span class="title class_">OrderParameters</span>_counter_offset</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Store the counter at the retrieved memory location.</span></span><br><span class="line">        <span class="title function_">mstore</span>(counterPtr, counter)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Derive the order hash using the full range of order parameters.</span></span><br><span class="line">        <span class="comment">// 返回 orderHash</span></span><br><span class="line">        orderHash := <span class="title function_">keccak256</span>(typeHashPtr, <span class="title class_">EIP712</span>_Order_size)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Restore the value previously held at typehash pointer location.</span></span><br><span class="line">        <span class="title function_">mstore</span>(typeHashPtr, previousValue)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Restore offer data pointer at the offer head pointer location.</span></span><br><span class="line">        <span class="title function_">mstore</span>(offerHeadPtr, offerDataPtr)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Restore consideration data pointer at the consideration head ptr.</span></span><br><span class="line">        <span class="title function_">mstore</span>(considerationHeadPtr, considerationDataPtr)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Restore consideration item length at the counter pointer.</span></span><br><span class="line">        <span class="title function_">mstore</span>(counterPtr, originalConsiderationLength)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="3-Order-Signature"><a href="#3-Order-Signature" class="headerlink" title="3. Order Signature"></a>3. Order Signature</h3><p>ts 版</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">signOrder</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">    orderComponents: OrderComponents,</span></span><br><span class="line"><span class="params">    signer: Wallet</span></span><br><span class="line"><span class="params">  </span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> signature = <span class="keyword">await</span> signer.<span class="title function_">_signTypedData</span>(</span><br><span class="line">      domainData,</span><br><span class="line">      orderType,</span><br><span class="line">      orderComponents</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 本地计算出来的 Hash 应该与 合约计算出来的 Hash 一致。</span></span><br><span class="line">    <span class="keyword">const</span> orderHash = <span class="keyword">await</span> <span class="title function_">getAndVerifyOrderHash</span>(orderComponents);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; domainSeparator &#125; = <span class="keyword">await</span> marketplaceContract.<span class="title function_">information</span>();</span><br><span class="line">    <span class="keyword">const</span> digest = <span class="title function_">keccak256</span>(</span><br><span class="line">      <span class="string">`0x1901<span class="subst">$&#123;domainSeparator.slice(<span class="number">2</span>)&#125;</span><span class="subst">$&#123;orderHash.slice(<span class="number">2</span>)&#125;</span>`</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> recoveredAddress = <span class="title function_">recoverAddress</span>(digest, signature);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">expect</span>(recoveredAddress).<span class="property">to</span>.<span class="title function_">equal</span>(signer.<span class="property">address</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> signature;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="4-Order-Create"><a href="#4-Order-Create" class="headerlink" title="4. Order Create"></a>4. Order Create</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createOrder start</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createOrder</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">  offerer: Wallet,</span></span><br><span class="line"><span class="params">  zone: Wallet | <span class="literal">undefined</span> | string = <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params">  offer: OfferItem[],</span></span><br><span class="line"><span class="params">  consideration: ConsiderationItem[],</span></span><br><span class="line"><span class="params">  orderType: number,</span></span><br><span class="line"><span class="params">  criteriaResolvers?: CriteriaResolver[],</span></span><br><span class="line"><span class="params">  timeFlag?: string | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  signer?: Wallet,</span></span><br><span class="line"><span class="params">  zoneHash = constants.HashZero,</span></span><br><span class="line"><span class="params">  conduitKey = constants.HashZero,</span></span><br><span class="line"><span class="params">  extraCheap = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取 offerer 当前 counter</span></span><br><span class="line">  <span class="keyword">const</span> counter = <span class="keyword">await</span> marketplaceContract.<span class="title function_">getCounter</span>(offerer.<span class="property">address</span>);</span><br><span class="line">  <span class="comment">// 获取盐值</span></span><br><span class="line">  <span class="keyword">const</span> salt = !extraCheap ? <span class="title function_">randomHex</span>() : constants.<span class="property">HashZero</span>;</span><br><span class="line">  <span class="keyword">const</span> startTime =</span><br><span class="line">    timeFlag !== <span class="string">&quot;NOT_STARTED&quot;</span> ? <span class="number">0</span> : <span class="title function_">toBN</span>(<span class="string">&quot;0xee00000000000000000000000000&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> endTime =</span><br><span class="line">    timeFlag !== <span class="string">&quot;EXPIRED&quot;</span> ? <span class="title function_">toBN</span>(<span class="string">&quot;0xff00000000000000000000000000&quot;</span>) : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> orderParameters = &#123;</span><br><span class="line">    <span class="attr">offerer</span>: offerer.<span class="property">address</span>,</span><br><span class="line">    <span class="attr">zone</span>: !extraCheap</span><br><span class="line">      ? (zone <span class="keyword">as</span> <span class="title class_">Wallet</span>).<span class="property">address</span> || (zone <span class="keyword">as</span> string)</span><br><span class="line">      : constants.<span class="property">AddressZero</span>,</span><br><span class="line">    offer,</span><br><span class="line">    consideration,</span><br><span class="line">    <span class="attr">totalOriginalConsiderationItems</span>: consideration.<span class="property">length</span>,</span><br><span class="line">    orderType,</span><br><span class="line">    zoneHash,</span><br><span class="line">    salt,</span><br><span class="line">    conduitKey,</span><br><span class="line">    startTime,</span><br><span class="line">    endTime,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> orderComponents = &#123;</span><br><span class="line">    ...orderParameters,</span><br><span class="line">    counter,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> orderHash = <span class="keyword">await</span> <span class="title function_">getAndVerifyOrderHash</span>(orderComponents);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; isValidated, isCancelled, totalFilled, totalSize &#125; =</span><br><span class="line">    <span class="keyword">await</span> marketplaceContract.<span class="title function_">getOrderStatus</span>(orderHash);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">expect</span>(isCancelled).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> orderStatus = &#123;</span><br><span class="line">    isValidated,</span><br><span class="line">    isCancelled,</span><br><span class="line">    totalFilled,</span><br><span class="line">    totalSize,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> flatSig = <span class="keyword">await</span> <span class="title function_">signOrder</span>(orderComponents, signer || offerer);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> order = &#123;</span><br><span class="line">    <span class="attr">parameters</span>: orderParameters,</span><br><span class="line">    <span class="attr">signature</span>: !extraCheap ? flatSig : <span class="title function_">convertSignatureToEIP2098</span>(flatSig),</span><br><span class="line">    <span class="attr">numerator</span>: <span class="number">1</span>, <span class="comment">// only used for advanced orders</span></span><br><span class="line">    <span class="attr">denominator</span>: <span class="number">1</span>, <span class="comment">// only used for advanced orders</span></span><br><span class="line">    <span class="attr">extraData</span>: <span class="string">&quot;0x&quot;</span>, <span class="comment">// only used for advanced orders</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// How much ether (at most) needs to be supplied when fulfilling the order</span></span><br><span class="line">  <span class="keyword">const</span> value = offer</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function">(<span class="params">x</span>) =&gt;</span></span><br><span class="line">      x.<span class="property">itemType</span> === <span class="number">0</span></span><br><span class="line">        ? x.<span class="property">endAmount</span>.<span class="title function_">gt</span>(x.<span class="property">startAmount</span>)</span><br><span class="line">          ? x.<span class="property">endAmount</span></span><br><span class="line">          : x.<span class="property">startAmount</span></span><br><span class="line">        : <span class="title function_">toBN</span>(<span class="number">0</span>)</span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="title function_">add</span>(b), <span class="title function_">toBN</span>(<span class="number">0</span>))</span><br><span class="line">    .<span class="title function_">add</span>(</span><br><span class="line">      consideration</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function">(<span class="params">x</span>) =&gt;</span></span><br><span class="line">          x.<span class="property">itemType</span> === <span class="number">0</span></span><br><span class="line">            ? x.<span class="property">endAmount</span>.<span class="title function_">gt</span>(x.<span class="property">startAmount</span>)</span><br><span class="line">              ? x.<span class="property">endAmount</span></span><br><span class="line">              : x.<span class="property">startAmount</span></span><br><span class="line">            : <span class="title function_">toBN</span>(<span class="number">0</span>)</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.<span class="title function_">add</span>(b), <span class="title function_">toBN</span>(<span class="number">0</span>))</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    order,</span><br><span class="line">    orderHash,</span><br><span class="line">    value,</span><br><span class="line">    orderStatus,</span><br><span class="line">    orderComponents,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://docs.opensea.io/v2.0/reference/seaport-overview">Seaport Overview</a><br><a target="_blank" rel="noopener" href="https://github.com/ProjectOpenSea/seaport">源码</a><br><a target="_blank" rel="noopener" href="https://rinkeby.etherscan.io/address/0x00000000006c3852cbEf3e08E8dF289169EdE581#writeContract">SeaPort 在 Rinkey 的部署</a><br><a target="_blank" rel="noopener" href="https://ethereum.stackexchange.com/questions/113221/what-is-the-purpose-of-unchecked-in-solidity">What is the purpose of “unchecked” in Solidity?</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/智能合约/">智能合约</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Seaport/">Seaport</a><a href="/tags/智能合约/">智能合约</a><a href="/tags/Order/">Order</a><a href="/tags/OpenSea/">OpenSea</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    
    &copy; 2025 YueGS
    
  </p>
</footer>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-116967169-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-116967169-1');
</script>

    
  </div>
</div>
</body>
</html>